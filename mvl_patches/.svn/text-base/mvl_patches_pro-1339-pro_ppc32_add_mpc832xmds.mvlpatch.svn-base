#! /usr/bin/env bash
# Patch: -pro_ppc32_add_mpc832xmds
# Date: Mon Jun 11 17:03:04 2007
# Source: Freescale Semiconductor
# MR: 21282
# Type: Enhancement
# Disposition: merged from Freescale.
# Signed-off-by: Randy Vinson <rvinson@mvista.com>
# Description:
# Add support for the Freescale MPC832x MDS reference platform.
# 
# This patch add support for the MPC832x MDS reference platform.
# The MPC832x processor family uses the E300C2 core which does not have a
# floating point unit. It therefore requires a soft-float toolchain.
# 

PATCHNUM=1339
LSPINFO=include/linux/lsppatchlevel.h
TMPFILE=/tmp/mvl_patch_$$

function dopatch() {
    patch $* >${TMPFILE} 2>&1 <<"EOF"
Source: Freescale Semiconductor
MR: 21282
Type: Enhancement
Disposition: merged from Freescale.
Signed-off-by: Randy Vinson <rvinson@mvista.com>
Description:
Add support for the Freescale MPC832x MDS reference platform.

This patch add support for the MPC832x MDS reference platform.
The MPC832x processor family uses the E300C2 core which does not have a
floating point unit. It therefore requires a soft-float toolchain.

Index: linux-2.6.10/arch/ppc/Kconfig
===================================================================
--- linux-2.6.10.orig/arch/ppc/Kconfig
+++ linux-2.6.10/arch/ppc/Kconfig
@@ -55,7 +55,6 @@ choice
 
 config 6xx
 	bool "6xx/7xx/74xx/52xx/82xx/83xx/86xx"
-	select PPC_FPU
 	help
 	  There are four types of PowerPC chips supported.  The more common
 	  types (601, 603, 604, 740, 750, 7400), the Motorola embedded
@@ -92,9 +91,6 @@ config E500
 
 endchoice
 
-config PPC_FPU
-	bool
-
 config BOOKE
 	bool
 	depends on E200 || E500
@@ -199,7 +195,8 @@ config TAU_AVERAGE
 
 config MATH_EMULATION
 	bool "Math emulation"
-	depends on 4xx || 8xx || E200 || E500
+	depends on 4xx || 8xx || E200 || E500 || E300C2
+	default y if E300C2
 	---help---
 	  Some PowerPC chips designed for embedded applications do not have
 	  a floating-point unit and therefore do not implement the
@@ -754,6 +751,11 @@ config MPC8360E_PB
 	help
 	  This option enables support for the MPC 8360E PB evaluation board.
 
+config MPC832XE_MDS
+	bool "Fresscale MPC832XE_MDS"
+	help
+	  This option enables support for the MPC 832XE MDS evaluation board.
+
 endchoice
 
 source arch/ppc/platforms/83xx/Kconfig
@@ -805,9 +807,24 @@ config MPC8360
 	depends on MPC8360E_PB
 	default y
 
+config MPC832X
+	bool
+	depends on MPC832XE_MDS
+	default y
+
 config 83xx
 	bool
-	default y if MPC834x || MPC8360
+	default y if MPC834x || MPC8360 || MPC832X
+
+config E300C2
+	bool
+	depends on MPC832X
+	default y
+
+config PPC_FPU
+	bool
+	depends on 6xx && !E300C2
+	default y
 
 config CPM1
  	bool
@@ -831,7 +848,7 @@ config CPM2
 
 config QE
 	bool
-	depends on MPC8360
+	depends on MPC8360 || MPC832X
 	default y
 	help
 	  The QE (QUICC Engine) is a coprocessor on embedded CPUs made
Index: linux-2.6.10/arch/ppc/configs/mpc832xe_mds_defconfig
===================================================================
--- /dev/null
+++ linux-2.6.10/arch/ppc/configs/mpc832xe_mds_defconfig
@@ -0,0 +1,1000 @@
+#
+# Automatically generated make config: don't edit
+# Linux kernel version: 2.6.10_mvl401
+# Wed Mar  7 11:32:32 2007
+#
+CONFIG_MMU=y
+CONFIG_GENERIC_HARDIRQS=y
+CONFIG_RWSEM_GENERIC_SPINLOCK=y
+CONFIG_ASM_SEMAPHORES=y
+CONFIG_HAVE_DEC_LOCK=y
+CONFIG_PPC=y
+CONFIG_PPC32=y
+CONFIG_GENERIC_NVRAM=y
+
+#
+# Code maturity level options
+#
+CONFIG_EXPERIMENTAL=y
+CONFIG_CLEAN_COMPILE=y
+CONFIG_BROKEN_ON_SMP=y
+CONFIG_LOCK_KERNEL=y
+
+#
+# General setup
+#
+CONFIG_LOCALVERSION=""
+CONFIG_SWAP=y
+CONFIG_SYSVIPC=y
+CONFIG_SYSVIPC_SEMMNI=128
+CONFIG_SYSVIPC_SEMMSL=250
+CONFIG_POSIX_MQUEUE=y
+# CONFIG_BSD_PROCESS_ACCT is not set
+CONFIG_SYSCTL=y
+# CONFIG_AUDIT is not set
+CONFIG_LOG_BUF_SHIFT=14
+CONFIG_HOTPLUG=y
+CONFIG_KOBJECT_UEVENT=y
+CONFIG_IKCONFIG=y
+CONFIG_IKCONFIG_PROC=y
+CONFIG_EMBEDDED=y
+# CONFIG_KALLSYMS is not set
+CONFIG_FUTEX=y
+CONFIG_EPOLL=y
+# CONFIG_CC_OPTIMIZE_FOR_SIZE is not set
+CONFIG_SHMEM=y
+CONFIG_CC_ALIGN_FUNCTIONS=0
+CONFIG_CC_ALIGN_LABELS=0
+CONFIG_CC_ALIGN_LOOPS=0
+CONFIG_CC_ALIGN_JUMPS=0
+CONFIG_LTT_MAX_HANDLES=128
+# CONFIG_BOOT_FLIGHT_RECORDER is not set
+CONFIG_LOCKLESS=y
+CONFIG_BOOT_FLIGHT_BUFFERS=4
+CONFIG_BOOT_FLIGHT_SIZE=524288
+CONFIG_FLIGHT_PROC_BUFFERS=8
+CONFIG_FLIGHT_PROC_SIZE=8192
+CONFIG_NEWEV=y
+CONFIG_CSTM=y
+# CONFIG_CREATE_DEV_CONSOLE is not set
+# CONFIG_TINY_SHMEM is not set
+
+#
+# Loadable module support
+#
+CONFIG_MODULES=y
+CONFIG_MODULE_UNLOAD=y
+CONFIG_MODULE_FORCE_UNLOAD=y
+CONFIG_OBSOLETE_MODPARM=y
+CONFIG_MODVERSIONS=y
+# CONFIG_MODULE_SRCVERSION_ALL is not set
+CONFIG_KMOD=y
+
+#
+# Processor
+#
+CONFIG_6xx=y
+# CONFIG_40x is not set
+# CONFIG_44x is not set
+# CONFIG_POWER3 is not set
+# CONFIG_POWER4 is not set
+# CONFIG_8xx is not set
+# CONFIG_E200 is not set
+# CONFIG_E500 is not set
+CONFIG_MATH_EMULATION=y
+# CONFIG_CPU_FREQ is not set
+CONFIG_PPC_GEN550=y
+CONFIG_PPC_STD_MMU=y
+
+#
+# Platform options
+#
+# CONFIG_PPC_MULTIPLATFORM is not set
+# CONFIG_APUS is not set
+# CONFIG_KATANA is not set
+# CONFIG_WILLOW is not set
+# CONFIG_TAIGA is not set
+# CONFIG_CPCI690 is not set
+# CONFIG_PCORE is not set
+# CONFIG_POWERPMC250 is not set
+# CONFIG_CHESTNUT is not set
+# CONFIG_SPRUCE is not set
+# CONFIG_EV64260 is not set
+# CONFIG_LOPEC is not set
+# CONFIG_MCPN765 is not set
+# CONFIG_MVME5100 is not set
+# CONFIG_PPLUS is not set
+# CONFIG_PRPMC275 is not set
+# CONFIG_PRPMC750 is not set
+# CONFIG_PRPMC800 is not set
+# CONFIG_SANDPOINT is not set
+# CONFIG_ADIR is not set
+# CONFIG_K2 is not set
+# CONFIG_PAL4 is not set
+# CONFIG_GEMINI is not set
+# CONFIG_EST8260 is not set
+# CONFIG_SBC82xx is not set
+# CONFIG_SBS8260 is not set
+# CONFIG_RPX8260 is not set
+# CONFIG_TQM8260 is not set
+# CONFIG_ADS8272 is not set
+# CONFIG_PQ2FADS is not set
+# CONFIG_LITE5200 is not set
+# CONFIG_MPC834x_SYS is not set
+# CONFIG_MPC834x_ITX is not set
+# CONFIG_MPC8641_HPCN is not set
+# CONFIG_MPC8360E_PB is not set
+CONFIG_MPC832XE_MDS=y
+CONFIG_MPC832X=y
+CONFIG_83xx=y
+CONFIG_E300C2=y
+CONFIG_QE=y
+# CONFIG_SMP is not set
+# CONFIG_PREEMPT_NONE is not set
+# CONFIG_PREEMPT_VOLUNTARY is not set
+CONFIG_PREEMPT_DESKTOP=y
+# CONFIG_PREEMPT_RT is not set
+CONFIG_PREEMPT=y
+# CONFIG_PREEMPT_SOFTIRQS is not set
+# CONFIG_PREEMPT_HARDIRQS is not set
+# CONFIG_PREEMPT_RCU is not set
+# CONFIG_SPINLOCK_BKL is not set
+CONFIG_PREEMPT_BKL=y
+# CONFIG_HIGHMEM is not set
+# CONFIG_HIGH_RES_TIMERS is not set
+CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_MISC is not set
+# CONFIG_CMDLINE_BOOL is not set
+
+#
+# Bus options
+#
+CONFIG_GENERIC_ISA_DMA=y
+# CONFIG_PCI is not set
+# CONFIG_PCI_DOMAINS is not set
+
+#
+# PCCARD (PCMCIA/CardBus) support
+#
+# CONFIG_PCCARD is not set
+
+#
+# PC-card bridges
+#
+
+#
+# Advanced setup
+#
+# CONFIG_ADVANCED_OPTIONS is not set
+
+#
+# Default settings for advanced configuration options are used
+#
+CONFIG_HIGHMEM_START=0xfe000000
+CONFIG_LOWMEM_SIZE=0x30000000
+CONFIG_KERNEL_START=0xc0000000
+CONFIG_TASK_SIZE=0x80000000
+CONFIG_BOOT_LOAD=0x00800000
+
+#
+# Device Drivers
+#
+
+#
+# Generic Driver Options
+#
+CONFIG_STANDALONE=y
+CONFIG_PREVENT_FIRMWARE_BUILD=y
+# CONFIG_FW_LOADER is not set
+
+#
+# Memory Technology Devices (MTD)
+#
+CONFIG_MTD=y
+# CONFIG_MTD_DEBUG is not set
+CONFIG_MTD_CONCAT=y
+CONFIG_MTD_PARTITIONS=y
+# CONFIG_MTD_REDBOOT_PARTS is not set
+# CONFIG_MTD_CMDLINE_PARTS is not set
+
+#
+# User Modules And Translation Layers
+#
+CONFIG_MTD_CHAR=y
+CONFIG_MTD_BLOCK=y
+# CONFIG_FTL is not set
+# CONFIG_NFTL is not set
+# CONFIG_INFTL is not set
+# CONFIG_RFD_FTL is not set
+
+#
+# RAM/ROM/Flash chip drivers
+#
+CONFIG_MTD_CFI=y
+# CONFIG_MTD_JEDECPROBE is not set
+CONFIG_MTD_GEN_PROBE=y
+# CONFIG_MTD_CFI_ADV_OPTIONS is not set
+CONFIG_MTD_MAP_BANK_WIDTH_1=y
+CONFIG_MTD_MAP_BANK_WIDTH_2=y
+CONFIG_MTD_MAP_BANK_WIDTH_4=y
+# CONFIG_MTD_MAP_BANK_WIDTH_8 is not set
+# CONFIG_MTD_MAP_BANK_WIDTH_16 is not set
+# CONFIG_MTD_MAP_BANK_WIDTH_32 is not set
+CONFIG_MTD_CFI_I1=y
+CONFIG_MTD_CFI_I2=y
+# CONFIG_MTD_CFI_I4 is not set
+# CONFIG_MTD_CFI_I8 is not set
+CONFIG_MTD_CFI_INTELEXT=y
+# CONFIG_MTD_CFI_AMDSTD is not set
+# CONFIG_MTD_CFI_STAA is not set
+CONFIG_MTD_CFI_UTIL=y
+# CONFIG_MTD_RAM is not set
+# CONFIG_MTD_ROM is not set
+# CONFIG_MTD_ABSENT is not set
+# CONFIG_MTD_XIP is not set
+
+#
+# Mapping drivers for chip access
+#
+# CONFIG_MTD_COMPLEX_MAPPINGS is not set
+CONFIG_MTD_PHYSMAP=y
+CONFIG_MTD_PHYSMAP_START=0xfe000000
+CONFIG_MTD_PHYSMAP_LEN=0x01000000
+CONFIG_MTD_PHYSMAP_BANKWIDTH=2
+# CONFIG_MTD_MULTI_PHYSMAP is not set
+# CONFIG_MTD_PLATRAM is not set
+
+#
+# Self-contained MTD device drivers
+#
+# CONFIG_MTD_SLRAM is not set
+# CONFIG_MTD_PHRAM is not set
+# CONFIG_MTD_MTDRAM is not set
+# CONFIG_RAMTD is not set
+# CONFIG_MTD_BLKMTD is not set
+# CONFIG_MTD_BLOCK2MTD is not set
+
+#
+# Disk-On-Chip Device Drivers
+#
+# CONFIG_MTD_DOC2000 is not set
+# CONFIG_MTD_DOC2001 is not set
+# CONFIG_MTD_DOC2001PLUS is not set
+
+#
+# NAND Flash Device Drivers
+#
+# CONFIG_MTD_NAND is not set
+
+#
+# Parallel port support
+#
+# CONFIG_PARPORT is not set
+
+#
+# Plug and Play support
+#
+
+#
+# Block devices
+#
+# CONFIG_BLK_DEV_FD is not set
+CONFIG_BLK_DEV_LOOP=y
+# CONFIG_BLK_DEV_CRYPTOLOOP is not set
+# CONFIG_BLK_DEV_NBD is not set
+CONFIG_BLK_DEV_RAM=y
+CONFIG_BLK_DEV_RAM_COUNT=16
+CONFIG_BLK_DEV_RAM_SIZE=32768
+CONFIG_BLK_DEV_INITRD=y
+CONFIG_INITRAMFS_SOURCE=""
+# CONFIG_LBD is not set
+# CONFIG_CDROM_PKTCDVD is not set
+
+#
+# IO Schedulers
+#
+CONFIG_IOSCHED_NOOP=y
+CONFIG_IOSCHED_AS=y
+CONFIG_IOSCHED_DEADLINE=y
+CONFIG_IOSCHED_CFQ=y
+
+#
+# ATA/ATAPI/MFM/RLL support
+#
+# CONFIG_IDE is not set
+
+#
+# SCSI device support
+#
+CONFIG_SCSI=y
+CONFIG_SCSI_PROC_FS=y
+
+#
+# SCSI support type (disk, tape, CD-ROM)
+#
+CONFIG_BLK_DEV_SD=y
+# CONFIG_CHR_DEV_ST is not set
+# CONFIG_CHR_DEV_OSST is not set
+# CONFIG_BLK_DEV_SR is not set
+CONFIG_CHR_DEV_SG=y
+
+#
+# Some SCSI devices (e.g. CD jukebox) support multiple LUNs
+#
+# CONFIG_SCSI_MULTI_LUN is not set
+# CONFIG_SCSI_CONSTANTS is not set
+# CONFIG_SCSI_LOGGING is not set
+
+#
+# SCSI Transport Attributes
+#
+# CONFIG_SCSI_SPI_ATTRS is not set
+# CONFIG_SCSI_FC_ATTRS is not set
+
+#
+# SCSI low-level drivers
+#
+# CONFIG_SCSI_SATA is not set
+# CONFIG_SCSI_DEBUG is not set
+
+#
+# Multi-device support (RAID and LVM)
+#
+# CONFIG_MD is not set
+
+#
+# Fusion MPT device support
+#
+
+#
+# IEEE 1394 (FireWire) support
+#
+
+#
+# I2O device support
+#
+
+#
+# Macintosh device drivers
+#
+
+#
+# Networking support
+#
+CONFIG_NET=y
+
+#
+# Networking options
+#
+CONFIG_PACKET=y
+# CONFIG_PACKET_MMAP is not set
+# CONFIG_NETLINK_DEV is not set
+CONFIG_UNIX=y
+# CONFIG_NET_KEY is not set
+CONFIG_USE_POLICY_FWD=y
+CONFIG_INET=y
+CONFIG_IP_MULTICAST=y
+# CONFIG_IP_ADVANCED_ROUTER is not set
+CONFIG_IP_PNP=y
+CONFIG_IP_PNP_DHCP=y
+CONFIG_IP_PNP_BOOTP=y
+# CONFIG_IP_PNP_RARP is not set
+# CONFIG_NET_IPIP is not set
+# CONFIG_NET_IPGRE is not set
+# CONFIG_IP_MROUTE is not set
+# CONFIG_ARPD is not set
+CONFIG_SYN_COOKIES=y
+# CONFIG_INET_AH is not set
+# CONFIG_INET_ESP is not set
+# CONFIG_INET_IPCOMP is not set
+# CONFIG_INET_TUNNEL is not set
+CONFIG_IP_TCPDIAG=y
+# CONFIG_IP_TCPDIAG_IPV6 is not set
+
+#
+# IP: Virtual Server Configuration
+#
+# CONFIG_IP_VS is not set
+CONFIG_IPV6=m
+# CONFIG_IPV6_PRIVACY is not set
+# CONFIG_IPV6_ROUTER_PREF is not set
+# CONFIG_INET6_AH is not set
+# CONFIG_INET6_ESP is not set
+# CONFIG_INET6_IPCOMP is not set
+# CONFIG_INET6_TUNNEL is not set
+# CONFIG_IPV6_TUNNEL is not set
+# CONFIG_IPV6_ADVANCED_ROUTER is not set
+# CONFIG_IPV6_MIP6 is not set
+CONFIG_NETFILTER=y
+# CONFIG_NETFILTER_DEBUG is not set
+
+#
+# IP: Netfilter Configuration
+#
+# CONFIG_IP_NF_CONNTRACK is not set
+# CONFIG_IP_NF_CONNTRACK_MARK is not set
+# CONFIG_IP_NF_QUEUE is not set
+# CONFIG_IP_NF_IPTABLES is not set
+# CONFIG_IP_NF_ARPTABLES is not set
+# CONFIG_IP_NF_COMPAT_IPCHAINS is not set
+# CONFIG_IP_NF_COMPAT_IPFWADM is not set
+
+#
+# IPv6: Netfilter Configuration
+#
+# CONFIG_IP6_NF_QUEUE is not set
+# CONFIG_IP6_NF_IPTABLES is not set
+# CONFIG_IP6_NF_CONNTRACK is not set
+
+#
+# SCTP Configuration (EXPERIMENTAL)
+#
+# CONFIG_IP_SCTP is not set
+# CONFIG_ATM is not set
+# CONFIG_BRIDGE is not set
+# CONFIG_VLAN_8021Q is not set
+# CONFIG_DECNET is not set
+# CONFIG_LLC2 is not set
+# CONFIG_IPX is not set
+# CONFIG_ATALK is not set
+# CONFIG_X25 is not set
+# CONFIG_LAPB is not set
+# CONFIG_NET_DIVERT is not set
+# CONFIG_ECONET is not set
+# CONFIG_WAN_ROUTER is not set
+
+#
+# QoS and/or fair queueing
+#
+# CONFIG_NET_SCHED is not set
+# CONFIG_NET_CLS_ROUTE is not set
+
+#
+# Network testing
+#
+# CONFIG_NET_PKTGEN is not set
+# CONFIG_NETPOLL is not set
+# CONFIG_NET_POLL_CONTROLLER is not set
+# CONFIG_HAMRADIO is not set
+# CONFIG_IRDA is not set
+# CONFIG_BT is not set
+# CONFIG_IEEE80211 is not set
+CONFIG_NETDEVICES=y
+# CONFIG_DUMMY is not set
+# CONFIG_BONDING is not set
+# CONFIG_EQUALIZER is not set
+CONFIG_TUN=m
+
+#
+# PHY device support
+#
+# CONFIG_PHYLIB is not set
+
+#
+# Ethernet (10 or 100Mbit)
+#
+CONFIG_NET_ETHERNET=y
+CONFIG_MII=y
+
+#
+# Broadcom network devices
+#
+# CONFIG_NEC_CANDY is not set
+
+#
+# Ethernet (1000 Mbit)
+#
+# CONFIG_GIANFAR is not set
+
+#
+# Ethernet (10000 Mbit)
+#
+
+#
+# Token Ring devices
+#
+
+#
+# Wireless LAN (non-hamradio)
+#
+# CONFIG_NET_RADIO is not set
+
+#
+# Wan interfaces
+#
+# CONFIG_WAN is not set
+CONFIG_PPP=m
+# CONFIG_PPP_MULTILINK is not set
+# CONFIG_PPP_FILTER is not set
+CONFIG_PPP_ASYNC=m
+CONFIG_PPP_SYNC_TTY=m
+CONFIG_PPP_DEFLATE=m
+# CONFIG_PPP_BSDCOMP is not set
+# CONFIG_PPPOE is not set
+# CONFIG_SLIP is not set
+# CONFIG_SHAPER is not set
+# CONFIG_NETCONSOLE is not set
+
+#
+# ISDN subsystem
+#
+# CONFIG_ISDN is not set
+
+#
+# Telephony Support
+#
+# CONFIG_PHONE is not set
+
+#
+# Input device support
+#
+CONFIG_INPUT=y
+
+#
+# Userland interfaces
+#
+# CONFIG_INPUT_MOUSEDEV is not set
+# CONFIG_INPUT_JOYDEV is not set
+# CONFIG_INPUT_TSDEV is not set
+# CONFIG_INPUT_TSLIBDEV is not set
+CONFIG_INPUT_EVDEV=m
+# CONFIG_INPUT_EVBUG is not set
+
+#
+# Input I/O drivers
+#
+# CONFIG_GAMEPORT is not set
+CONFIG_SOUND_GAMEPORT=y
+# CONFIG_SERIO is not set
+# CONFIG_SERIO_I8042 is not set
+
+#
+# Input Device Drivers
+#
+# CONFIG_INPUT_KEYBOARD is not set
+# CONFIG_INPUT_MOUSE is not set
+# CONFIG_INPUT_JOYSTICK is not set
+# CONFIG_INPUT_TOUCHSCREEN is not set
+# CONFIG_INPUT_MISC is not set
+
+#
+# Character devices
+#
+# CONFIG_VT is not set
+# CONFIG_SERIAL_NONSTANDARD is not set
+
+#
+# Serial drivers
+#
+CONFIG_SERIAL_8250=y
+CONFIG_SERIAL_8250_CONSOLE=y
+CONFIG_SERIAL_8250_NR_UARTS=2
+# CONFIG_SERIAL_8250_EXTENDED is not set
+
+#
+# Non-8250 serial port support
+#
+CONFIG_SERIAL_CORE=y
+CONFIG_SERIAL_CORE_CONSOLE=y
+CONFIG_UNIX98_PTYS=y
+CONFIG_LEGACY_PTYS=y
+CONFIG_LEGACY_PTY_COUNT=256
+
+#
+# IPMI
+#
+# CONFIG_IPMI_HANDLER is not set
+
+#
+# Watchdog Cards
+#
+# CONFIG_WATCHDOG is not set
+# CONFIG_NVRAM is not set
+# CONFIG_BLOCKER is not set
+CONFIG_GEN_RTC=y
+# CONFIG_GEN_RTC_X is not set
+# CONFIG_DTLK is not set
+# CONFIG_R3964 is not set
+
+#
+# Ftape, the floppy tape device driver
+#
+# CONFIG_AGP is not set
+# CONFIG_DRM is not set
+# CONFIG_RAW_DRIVER is not set
+
+#
+# I2C support
+#
+CONFIG_I2C=y
+CONFIG_I2C_CHARDEV=y
+
+#
+# I2C Algorithms
+#
+# CONFIG_I2C_ALGOBIT is not set
+# CONFIG_I2C_ALGOPCF is not set
+# CONFIG_I2C_ALGOPCA is not set
+# CONFIG_I2C_ALGO_SGI is not set
+
+#
+# I2C Hardware Bus support
+#
+# CONFIG_I2C_ISA is not set
+CONFIG_I2C_MPC=y
+# CONFIG_I2C_PARPORT_LIGHT is not set
+# CONFIG_I2C_STUB is not set
+# CONFIG_I2C_PCA_ISA is not set
+# CONFIG_I2C_OMAP is not set
+
+#
+# Hardware Sensors Chip support
+#
+CONFIG_I2C_SENSOR=y
+# CONFIG_SENSORS_ADM1021 is not set
+# CONFIG_SENSORS_ADM1025 is not set
+# CONFIG_SENSORS_ADM1026 is not set
+# CONFIG_SENSORS_ADM1031 is not set
+# CONFIG_SENSORS_ASB100 is not set
+# CONFIG_SENSORS_DS1621 is not set
+# CONFIG_SENSORS_FSCHER is not set
+# CONFIG_SENSORS_GL518SM is not set
+# CONFIG_SENSORS_IT87 is not set
+# CONFIG_SENSORS_LM63 is not set
+# CONFIG_SENSORS_LM75 is not set
+# CONFIG_SENSORS_LM77 is not set
+# CONFIG_SENSORS_LM78 is not set
+# CONFIG_SENSORS_LM80 is not set
+# CONFIG_SENSORS_LM83 is not set
+# CONFIG_SENSORS_LM85 is not set
+# CONFIG_SENSORS_LM87 is not set
+# CONFIG_SENSORS_LM90 is not set
+# CONFIG_SENSORS_MAX1619 is not set
+# CONFIG_SENSORS_PC87360 is not set
+# CONFIG_SENSORS_SMSC47M1 is not set
+# CONFIG_SENSORS_W83781D is not set
+# CONFIG_SENSORS_W83L785TS is not set
+# CONFIG_SENSORS_W83627HF is not set
+
+#
+# Other I2C Chip support
+#
+CONFIG_SENSORS_DS1374=y
+# CONFIG_SENSORS_DS1338 is not set
+# CONFIG_SENSORS_RV5C387A is not set
+# CONFIG_SENSORS_EEPROM is not set
+# CONFIG_SENSORS_PCF8574 is not set
+# CONFIG_SENSORS_PCF8591 is not set
+# CONFIG_SENSORS_RTC8564 is not set
+# CONFIG_SENSORS_M41T00 is not set
+# CONFIG_SENSORS_MAX6900 is not set
+# CONFIG_TPS65010 is not set
+# CONFIG_SENSORS_BU9929FV is not set
+# CONFIG_I2C_DEBUG_CORE is not set
+# CONFIG_I2C_DEBUG_ALGO is not set
+# CONFIG_I2C_DEBUG_BUS is not set
+# CONFIG_I2C_DEBUG_CHIP is not set
+
+#
+# SPI support
+#
+# CONFIG_SPI is not set
+# CONFIG_SPI_MASTER is not set
+
+#
+# Dallas's 1-wire bus
+#
+# CONFIG_W1 is not set
+
+#
+# Misc devices
+#
+
+#
+# Multimedia Capabilities Port drivers
+#
+
+#
+# Multimedia devices
+#
+# CONFIG_VIDEO_DEV is not set
+
+#
+# Digital Video Broadcasting Devices
+#
+# CONFIG_DVB is not set
+
+#
+# Graphics support
+#
+# CONFIG_FB is not set
+
+#
+# Sound
+#
+# CONFIG_SOUND is not set
+
+#
+# USB support
+#
+# CONFIG_USB is not set
+CONFIG_USB_ARCH_HAS_HCD=y
+# CONFIG_USB_ARCH_HAS_OHCI is not set
+
+#
+# Enable Host or Gadget support to see Inventra options
+#
+
+#
+# NOTE: USB_STORAGE enables SCSI, and 'SCSI disk support' may also be needed; see USB_STORAGE Help for more information
+#
+
+#
+# USB Gadget Support
+#
+# CONFIG_USB_GADGET is not set
+
+#
+# MMC/SD Card support
+#
+# CONFIG_MMC is not set
+
+#
+# Synchronous Serial Interfaces (SSI)
+#
+
+#
+# Real Time Clock
+#
+# CONFIG_RTC_CLASS is not set
+
+#
+# File systems
+#
+CONFIG_EXT2_FS=y
+# CONFIG_EXT2_FS_XATTR is not set
+CONFIG_EXT3_FS=y
+CONFIG_EXT3_FS_XATTR=y
+# CONFIG_EXT3_FS_POSIX_ACL is not set
+# CONFIG_EXT3_FS_SECURITY is not set
+CONFIG_JBD=y
+# CONFIG_JBD_DEBUG is not set
+CONFIG_FS_MBCACHE=y
+# CONFIG_REISERFS_FS is not set
+# CONFIG_JFS_FS is not set
+CONFIG_XFS_FS=m
+# CONFIG_XFS_RT is not set
+# CONFIG_XFS_QUOTA is not set
+# CONFIG_XFS_SECURITY is not set
+# CONFIG_XFS_POSIX_ACL is not set
+# CONFIG_MINIX_FS is not set
+# CONFIG_ROMFS_FS is not set
+# CONFIG_QUOTA is not set
+CONFIG_DNOTIFY=y
+# CONFIG_AUTOFS_FS is not set
+CONFIG_AUTOFS4_FS=m
+
+#
+# CD-ROM/DVD Filesystems
+#
+# CONFIG_ISO9660_FS is not set
+# CONFIG_UDF_FS is not set
+
+#
+# DOS/FAT/NT Filesystems
+#
+CONFIG_FAT_FS=y
+CONFIG_MSDOS_FS=y
+CONFIG_VFAT_FS=y
+CONFIG_FAT_DEFAULT_CODEPAGE=437
+CONFIG_FAT_DEFAULT_IOCHARSET="iso8859-1"
+# CONFIG_NTFS_FS is not set
+
+#
+# Pseudo filesystems
+#
+CONFIG_PROC_FS=y
+CONFIG_PROC_KCORE=y
+CONFIG_SYSFS=y
+# CONFIG_DEVFS_FS is not set
+# CONFIG_DEVPTS_FS_XATTR is not set
+CONFIG_TMPFS=y
+# CONFIG_TMPFS_XATTR is not set
+# CONFIG_HUGETLB_PAGE is not set
+CONFIG_RAMFS=y
+# CONFIG_RELAYFS_FS is not set
+
+#
+# Miscellaneous filesystems
+#
+# CONFIG_ADFS_FS is not set
+# CONFIG_AFFS_FS is not set
+# CONFIG_HFS_FS is not set
+# CONFIG_HFSPLUS_FS is not set
+# CONFIG_BEFS_FS is not set
+# CONFIG_BFS_FS is not set
+# CONFIG_EFS_FS is not set
+# CONFIG_JFFS_FS is not set
+CONFIG_JFFS2_FS=y
+CONFIG_JFFS2_FS_DEBUG=0
+CONFIG_JFFS2_FS_WRITEBUFFER=y
+# CONFIG_JFFS2_COMPRESSION_OPTIONS is not set
+CONFIG_JFFS2_ZLIB=y
+CONFIG_JFFS2_RTIME=y
+# CONFIG_JFFS2_RUBIN is not set
+CONFIG_CRAMFS=y
+# CONFIG_CRAMFS_LINEAR is not set
+# CONFIG_VXFS_FS is not set
+# CONFIG_HPFS_FS is not set
+# CONFIG_QNX4FS_FS is not set
+# CONFIG_SYSV_FS is not set
+# CONFIG_UFS_FS is not set
+# CONFIG_YAFFS_FS is not set
+# CONFIG_YAFFS1_FS is not set
+
+#
+# Network File Systems
+#
+CONFIG_NFS_FS=y
+CONFIG_NFS_V3=y
+# CONFIG_NFS_V4 is not set
+# CONFIG_NFS_DIRECTIO is not set
+CONFIG_NFSD=m
+CONFIG_NFSD_V3=y
+# CONFIG_NFSD_V4 is not set
+CONFIG_NFSD_TCP=y
+CONFIG_ROOT_NFS=y
+CONFIG_LOCKD=y
+CONFIG_LOCKD_V4=y
+CONFIG_EXPORTFS=m
+CONFIG_SUNRPC=y
+# CONFIG_RPCSEC_GSS_KRB5 is not set
+# CONFIG_RPCSEC_GSS_SPKM3 is not set
+CONFIG_SMB_FS=m
+# CONFIG_SMB_NLS_DEFAULT is not set
+# CONFIG_CIFS is not set
+# CONFIG_NCP_FS is not set
+# CONFIG_CODA_FS is not set
+# CONFIG_AFS_FS is not set
+
+#
+# Partition Types
+#
+CONFIG_PARTITION_ADVANCED=y
+# CONFIG_ACORN_PARTITION is not set
+# CONFIG_OSF_PARTITION is not set
+# CONFIG_AMIGA_PARTITION is not set
+# CONFIG_ATARI_PARTITION is not set
+# CONFIG_MAC_PARTITION is not set
+CONFIG_MSDOS_PARTITION=y
+# CONFIG_BSD_DISKLABEL is not set
+# CONFIG_MINIX_SUBPARTITION is not set
+# CONFIG_SOLARIS_X86_PARTITION is not set
+# CONFIG_UNIXWARE_DISKLABEL is not set
+# CONFIG_LDM_PARTITION is not set
+# CONFIG_SGI_PARTITION is not set
+# CONFIG_ULTRIX_PARTITION is not set
+# CONFIG_SUN_PARTITION is not set
+# CONFIG_EFI_PARTITION is not set
+
+#
+# Native Language Support
+#
+CONFIG_NLS=y
+CONFIG_NLS_DEFAULT="iso8859-1"
+CONFIG_NLS_CODEPAGE_437=y
+# CONFIG_NLS_CODEPAGE_737 is not set
+# CONFIG_NLS_CODEPAGE_775 is not set
+# CONFIG_NLS_CODEPAGE_850 is not set
+# CONFIG_NLS_CODEPAGE_852 is not set
+# CONFIG_NLS_CODEPAGE_855 is not set
+# CONFIG_NLS_CODEPAGE_857 is not set
+# CONFIG_NLS_CODEPAGE_860 is not set
+# CONFIG_NLS_CODEPAGE_861 is not set
+# CONFIG_NLS_CODEPAGE_862 is not set
+# CONFIG_NLS_CODEPAGE_863 is not set
+# CONFIG_NLS_CODEPAGE_864 is not set
+# CONFIG_NLS_CODEPAGE_865 is not set
+# CONFIG_NLS_CODEPAGE_866 is not set
+# CONFIG_NLS_CODEPAGE_869 is not set
+# CONFIG_NLS_CODEPAGE_936 is not set
+# CONFIG_NLS_CODEPAGE_950 is not set
+# CONFIG_NLS_CODEPAGE_932 is not set
+# CONFIG_NLS_CODEPAGE_949 is not set
+# CONFIG_NLS_CODEPAGE_874 is not set
+CONFIG_NLS_ISO8859_8=y
+# CONFIG_NLS_CODEPAGE_1250 is not set
+# CONFIG_NLS_CODEPAGE_1251 is not set
+CONFIG_NLS_ASCII=m
+CONFIG_NLS_ISO8859_1=y
+# CONFIG_NLS_ISO8859_2 is not set
+# CONFIG_NLS_ISO8859_3 is not set
+# CONFIG_NLS_ISO8859_4 is not set
+# CONFIG_NLS_ISO8859_5 is not set
+# CONFIG_NLS_ISO8859_6 is not set
+# CONFIG_NLS_ISO8859_7 is not set
+# CONFIG_NLS_ISO8859_9 is not set
+# CONFIG_NLS_ISO8859_13 is not set
+# CONFIG_NLS_ISO8859_14 is not set
+# CONFIG_NLS_ISO8859_15 is not set
+# CONFIG_NLS_KOI8_R is not set
+# CONFIG_NLS_KOI8_U is not set
+CONFIG_NLS_UTF8=m
+
+#
+# QE Options
+#
+# CONFIG_UCC1 is not set
+# CONFIG_UCC2 is not set
+CONFIG_UCC3=y
+# CONFIG_UCC3_SLOW is not set
+CONFIG_UCC3_FAST=y
+
+#
+# UCC3 Protocols options
+#
+CONFIG_UCC3_GETH=y
+CONFIG_UCC4=y
+# CONFIG_UCC4_SLOW is not set
+CONFIG_UCC4_FAST=y
+
+#
+# UCC4 Protocols options
+#
+CONFIG_UCC4_GETH=y
+# CONFIG_UCC5 is not set
+# CONFIG_UCC6 is not set
+# CONFIG_UCC7 is not set
+# CONFIG_UCC8 is not set
+CONFIG_UCC=y
+CONFIG_UCC_FAST=y
+CONFIG_UCC_GETH=y
+
+#
+# Library routines
+#
+CONFIG_CRC_CCITT=m
+CONFIG_CRC32=y
+# CONFIG_LIBCRC32C is not set
+CONFIG_ZLIB_INFLATE=y
+CONFIG_ZLIB_DEFLATE=y
+
+#
+# Fast Real-Time Domain
+#
+# CONFIG_FRD is not set
+
+#
+# Fast Real-Time Domain Advanced Options
+#
+
+#
+# Profiling support
+#
+# CONFIG_PROFILING is not set
+
+#
+# MontaVista System tools
+#
+# CONFIG_ILATENCY is not set
+
+#
+# Kernel hacking
+#
+# CONFIG_DEBUG_KERNEL is not set
+# CONFIG_DEBUG_PREEMPT is not set
+# CONFIG_WAKEUP_TIMING is not set
+# CONFIG_CRITICAL_PREEMPT_TIMING is not set
+# CONFIG_CRITICAL_IRQSOFF_TIMING is not set
+# CONFIG_SERIAL_TEXT_DEBUG is not set
+
+#
+# Security options
+#
+# CONFIG_KEYS is not set
+# CONFIG_SECURITY is not set
+
+#
+# Cryptographic options
+#
+# CONFIG_CRYPTO is not set
Index: linux-2.6.10/arch/ppc/kernel/cputable.c
===================================================================
--- linux-2.6.10.orig/arch/ppc/kernel/cputable.c
+++ linux-2.6.10/arch/ppc/kernel/cputable.c
@@ -582,7 +582,7 @@ struct cpu_spec	cpu_specs[] = {
 	{	/* e300 (a 603e core, plus some) on 83xx */
 		.pvr_mask		= 0x7fff0000,
 		.pvr_value		= 0x00830000,
-		.cpu_name		= "e300",
+		.cpu_name		= "e300c1",
 		.cpu_features		= CPU_FTR_COMMON |
 			CPU_FTR_SPLIT_ID_CACHE | CPU_FTR_MAYBE_CAN_DOZE |
 			CPU_FTR_USE_TB | CPU_FTR_MAYBE_CAN_NAP |
@@ -592,6 +592,19 @@ struct cpu_spec	cpu_specs[] = {
 		.dcache_bsize		= 32,
 		.cpu_setup		= __setup_cpu_603
 	},
+	{       /* e300c2 (an e300c1 core, plus some, minus FPU) on 83xx */
+		.pvr_mask		= 0x7fff0000,
+		.pvr_value		= 0x00840000,
+		.cpu_name		= "e300c2",
+		.cpu_features		= CPU_FTR_COMMON |
+			CPU_FTR_SPLIT_ID_CACHE | CPU_FTR_MAYBE_CAN_DOZE |
+			CPU_FTR_USE_TB | CPU_FTR_MAYBE_CAN_NAP |
+			CPU_FTR_HAS_HIGH_BATS,
+		.cpu_user_features	= PPC_FEATURE_32 | PPC_FEATURE_HAS_MMU,
+		.icache_bsize		= 32,
+		.dcache_bsize		= 32,
+		.cpu_setup		= __setup_cpu_603
+	},
 	{	/* default match, we assume split I/D cache & TB (non-601)... */
 		.pvr_mask		= 0x00000000,
 		.pvr_value		= 0x00000000,
Index: linux-2.6.10/arch/ppc/kernel/head.S
===================================================================
--- linux-2.6.10.orig/arch/ppc/kernel/head.S
+++ linux-2.6.10/arch/ppc/kernel/head.S
@@ -475,9 +475,14 @@ Alignment:
 	. = 0x800
 FPUnavailable:
 	EXCEPTION_PROLOG
+#ifdef CONFIG_E300C2
+	addi	r3,r1,STACK_FRAME_OVERHEAD
+	EXC_XFER_EE(0x800, ProgramCheckException)
+#else
 	bne	load_up_fpu		/* if from user, just load it up */
 	addi	r3,r1,STACK_FRAME_OVERHEAD
 	EXC_XFER_EE_LITE(0x800, KernelFP)
+#endif
 
 /* Decrementer */
 	EXCEPTION(0x900, Decrementer, timer_interrupt, EXC_XFER_LITE)
@@ -1264,6 +1269,14 @@ start_here:
 	mtspr	SRR1,r4
 	SYNC
 	RFI
+/*
+ * extern void giveup_fpu(struct task_struct *prev)
+ */
+#ifndef CONFIG_PPC_FPU
+	.globl	giveup_fpu
+giveup_fpu:
+	blr
+#endif
 
 /*
  * Set up the segment registers for a new context.
Index: linux-2.6.10/arch/ppc/platforms/83xx/Makefile
===================================================================
--- linux-2.6.10.orig/arch/ppc/platforms/83xx/Makefile
+++ linux-2.6.10/arch/ppc/platforms/83xx/Makefile
@@ -4,3 +4,4 @@
 obj-$(CONFIG_MPC834x_SYS)	+= mpc834x_sys.o
 obj-$(CONFIG_MPC834x_ITX)	+= mpc834x_itx.o
 obj-$(CONFIG_MPC8360E_PB)	+= mpc8360e_pb.o
+obj-$(CONFIG_MPC832XE_MDS)	+= mpc832xe_mds.o
Index: linux-2.6.10/arch/ppc/platforms/83xx/mpc832xe_mds.c
===================================================================
--- /dev/null
+++ linux-2.6.10/arch/ppc/platforms/83xx/mpc832xe_mds.c
@@ -0,0 +1,679 @@
+/*
+ * arch/ppc/platforms/83xx/mpc832xe_mds.c
+ *
+ * Description: MPC832XE MDS board specific routines
+ *
+ * Author: Shlomi Gridish <gridish@freescale.com>
+ *
+ * Copyright (C) Freescale Semiconductor, Inc. 2005. All rights reserved.
+ *
+ * This program is free software; you can redistribute  it and/or modify it
+ * under  the terms of  the GNU General  Public License as published by the
+ * Free Software Foundation;  either version 2 of the  License, or (at your
+ * option) any later version.
+ */
+
+#include <linux/config.h>
+#include <linux/stddef.h>
+#include <linux/kernel.h>
+#include <linux/init.h>
+#include <linux/errno.h>
+#include <linux/reboot.h>
+#include <linux/pci.h>
+#include <linux/kdev_t.h>
+#include <linux/major.h>
+#include <linux/console.h>
+#include <linux/delay.h>
+#include <linux/irq.h>
+#include <linux/seq_file.h>
+#include <linux/root_dev.h>
+#include <linux/serial.h>
+#include <linux/tty.h>	/* for linux/serial_core.h */
+#include <linux/serial_core.h>
+#include <linux/mtd/physmap.h>
+#include <linux/initrd.h>
+#include <linux/module.h>
+#include <linux/fsl_devices.h>
+
+#include <asm/system.h>
+#include <asm/pgtable.h>
+#include <asm/page.h>
+#include <asm/atomic.h>
+#include <asm/time.h>
+#include <asm/io.h>
+#include <asm/machdep.h>
+#include <asm/prom.h>
+#include <asm/ipic.h>
+#ifdef CONFIG_QE
+#include <asm/qe_ic.h>
+#endif /* CONFIG_QE */
+#include <asm/bootinfo.h>
+#include <asm/pci-bridge.h>
+#include <asm/mpc83xx.h>
+#include <asm/irq.h>
+#include <asm/kgdb.h>
+#include <asm/ppc_sys.h>
+#include <mm/mmu_decl.h>
+
+#include <syslib/ppc83xx_setup.h>
+
+#ifdef CONFIG_QE
+extern void qe_reset(void);
+#endif /* CONFIG_QE */
+
+#ifndef CONFIG_PCI
+unsigned long isa_io_base = 0;
+unsigned long isa_mem_base = 0;
+#endif /* CONFIG_PCI */
+
+extern unsigned long total_memory;	/* in mm/init */
+
+unsigned char __res[sizeof (bd_t)];
+
+#define NUM_OF_PINS     32
+#define NUM_OF_PAR_IOS  4
+
+typedef struct par_io {
+    struct
+    {
+        u32 cpodr;  /* Open drain register */
+        u32 cpdata; /* Data register */
+        u32 cpdir1; /* Direction register */
+        u32 cpdir2; /* Direction register */
+        u32 cppar1; /* Pin assignment register */
+        u32 cppar2; /* Pin assignment register */
+    } io_regs[NUM_OF_PAR_IOS];
+} par_io_t;
+
+typedef struct qe_par_io {
+    u8  res[0xc];
+    u32 cepier;  /* QE ports interrupt event register */
+    u32 cepimr;  /* QE ports mask event register */
+    u32 cepicr;  /* QE ports control event register */
+} qe_par_io_t;
+
+static int		qe_irq_ports[NUM_OF_PAR_IOS][NUM_OF_PINS] = {
+    /* 0-7 */           /* 8-15 */          /* 16 - 23 */       /* 24 - 31 */
+    {0,0,0,0,0,0,0,0,   0,0,0,0,0,0,0,1,    1,0,0,0,0,0,0,0,    0,0,0,0,0,1,1,0},
+    {0,0,0,1,0,1,0,0,   0,0,0,0,1,1,0,0,    0,0,0,0,0,1,0,1,    0,0,0,0,0,0,1,1},
+    {0,0,0,0,0,0,0,0,   0,0,0,0,0,0,0,0,    0,0,0,0,0,0,0,0,    0,0,0,1,1,1,0,0},
+    {0,0,0,0,0,0,0,0,   0,0,0,0,1,1,0,0,    1,1,0,0,0,0,0,0,    0,0,1,1,0,0,0,0}
+};
+
+static u8 get_irq_num(u8 port, u8 pin)
+{
+    int     i, j;
+    u8      num = 0;
+
+    for (j=0;j<=port;j++)
+        for (i=0;i<pin;i++)
+            if(qe_irq_ports[j][i])
+                num++;
+    return num;
+}
+
+static par_io_t    *par_io = NULL;
+static qe_par_io_t *qe_par_io = NULL;
+
+int par_io_config_pin(u8  port, u8  pin, int dir, int open_drain,
+			int assignment, int has_irq)
+{
+	u32 pinMask1bit, pinMask2bits, newMask2bits, tmp_val;
+
+	if(!par_io) {
+		par_io = (par_io_t *)ioremap(immrbar + 0x1400, sizeof(par_io_t));
+		qe_par_io = (qe_par_io_t *)ioremap(immrbar + 0xC00,
+				sizeof(qe_par_io_t));
+
+		/* clear event bits in the event register of the QE ports */
+		out_be32(&qe_par_io->cepier, 0xFFFFFFFF);
+	}
+
+	/* calculate pin location for single and 2 bits  information */
+	pinMask1bit = (u32)(1 << (NUM_OF_PINS - (pin+1)));
+
+	/* Set open drain, if required */
+	tmp_val = in_be32(&par_io->io_regs[port].cpodr);
+	if (open_drain)
+		out_be32(&par_io->io_regs[port].cpodr, pinMask1bit | tmp_val);
+	else
+		out_be32(&par_io->io_regs[port].cpodr, ~pinMask1bit & tmp_val);
+
+	/* define direction */
+	tmp_val = (pin >  (NUM_OF_PINS/2) - 1) ?
+		in_be32(&par_io->io_regs[port].cpdir2):
+		in_be32(&par_io->io_regs[port].cpdir1);
+
+	/* get all bits mask for 2 bit per port */
+	pinMask2bits = (u32)(0x3 << (NUM_OF_PINS - (pin % (NUM_OF_PINS/2) +1)*2));
+
+	/* Get the final mask we need for the right definition */
+	newMask2bits = (u32)(dir << (NUM_OF_PINS - (pin % (NUM_OF_PINS/2)  +1)*2));
+
+	/* clear and set 2 bits mask */
+	if (pin >  (NUM_OF_PINS/2) - 1) {
+		out_be32(&par_io->io_regs[port].cpdir2, ~pinMask2bits & tmp_val);
+		tmp_val &= ~pinMask2bits;
+		out_be32(&par_io->io_regs[port].cpdir2, newMask2bits | tmp_val);
+	} else {
+		out_be32(&par_io->io_regs[port].cpdir1, ~pinMask2bits & tmp_val);
+		tmp_val &= ~pinMask2bits;
+		out_be32(&par_io->io_regs[port].cpdir1, newMask2bits | tmp_val);
+	}
+	/* define pin assignment */
+	tmp_val = (pin >  (NUM_OF_PINS/2) - 1) ?
+				in_be32(&par_io->io_regs[port].cppar2):
+				in_be32(&par_io->io_regs[port].cppar1);
+
+	newMask2bits = (u32)(assignment << (NUM_OF_PINS - (pin % (NUM_OF_PINS/2)  +1)*2));
+	/* clear and set 2 bits mask */
+	if (pin >  (NUM_OF_PINS/2) - 1) {
+		out_be32(&par_io->io_regs[port].cppar2, ~pinMask2bits & tmp_val);
+		tmp_val &= ~pinMask2bits;
+		out_be32(&par_io->io_regs[port].cppar2, newMask2bits | tmp_val);
+	} else {
+		out_be32(&par_io->io_regs[port].cppar1, ~pinMask2bits & tmp_val);
+		tmp_val &= ~pinMask2bits;
+		out_be32(&par_io->io_regs[port].cppar1, newMask2bits | tmp_val);
+	}
+
+	/* If this pin should not generate interrupt clear event mask bit */
+	if(has_irq) {
+		int i, j, k=0;
+		int irq = get_irq_num(port, pin);
+		u32 mask=0;
+
+		for (j=0;j<NUM_OF_PAR_IOS;j++)
+            for (i=0;i<NUM_OF_PINS;i++) {
+                if(qe_irq_ports[j][i]) {
+                    if (k == irq) {
+                        mask = 0x80000000 >> k;
+                        break;
+                    }
+                    k++;
+                }
+            }
+
+        if (!mask)
+	        return -EINVAL;
+
+     	tmp_val = in_be32(&qe_par_io->cepimr);
+	    out_be32(&qe_par_io->cepimr, ~mask & tmp_val);
+    }
+
+	return 0;
+}
+EXPORT_SYMBOL(par_io_config_pin);
+
+int par_io_data_set(u8 port, u8 pin, u8 val)
+{
+	u32 pin_mask, tmp_val;
+
+	if (port >= NUM_OF_PAR_IOS)
+		return -EINVAL;
+	if (pin >= NUM_OF_PINS)
+		return -EINVAL;
+
+	/* calculate pin location */
+	pin_mask = (u32)(1 << (NUM_OF_PINS - 1 - pin));
+
+	tmp_val = in_be32(&par_io->io_regs[port].cpdata);
+
+	if (val == 0) /* clear  */
+		out_be32(&par_io->io_regs[port].cpdata, ~pin_mask & tmp_val);
+	else	/* set */
+		out_be32(&par_io->io_regs[port].cpdata, pin_mask | tmp_val);
+	return 0;
+}
+EXPORT_SYMBOL(par_io_data_set);
+
+u8 par_io_data_get(u8 port, u8 pin)
+{
+	u32 pin_mask;
+
+	if (port >= NUM_OF_PAR_IOS)
+		return -EINVAL;
+	if (pin >= NUM_OF_PINS)
+		return -EINVAL;
+
+	/*calculate pin location*/
+	pin_mask = (u32)(1 << (NUM_OF_PINS - 1 - pin));
+
+	return((u8)!!(in_be32(&par_io->io_regs[port].cpdata) & pin_mask));
+}
+EXPORT_SYMBOL(par_io_data_get);
+
+static void dump_par_io(void)
+{
+	int i;
+
+	printk(KERN_INFO "PAR IO registars:\n");
+	printk(KERN_INFO "Base address: 0x%08x\n", (u32)par_io);
+	for (i=0;i<NUM_OF_PAR_IOS;i++) {
+		printk(KERN_INFO "cpodr[%d] : addr - 0x%08x, val - 0x%08x\n", i,
+			(u32)&par_io->io_regs[i].cpodr,
+			in_be32(&par_io->io_regs[i].cpodr));
+		printk(KERN_INFO "cpdata[%d]: addr - 0x%08x, val - 0x%08x\n", i,
+			(u32)&par_io->io_regs[i].cpdata,
+			in_be32(&par_io->io_regs[i].cpdata));
+		printk(KERN_INFO "cpdir1[%d]: addr - 0x%08x, val - 0x%08x\n", i,
+			(u32)&par_io->io_regs[i].cpdir1,
+			in_be32(&par_io->io_regs[i].cpdir1));
+		printk(KERN_INFO "cpdir2[%d]: addr - 0x%08x, val - 0x%08x\n", i,
+			(u32)&par_io->io_regs[i].cpdir2,
+			in_be32(&par_io->io_regs[i].cpdir2));
+		printk(KERN_INFO "cppar1[%d]: addr - 0x%08x, val - 0x%08x\n", i,
+			(u32)&par_io->io_regs[i].cppar1,
+			in_be32(&par_io->io_regs[i].cppar1));
+		printk(KERN_INFO "cppar2[%d]: addr - 0x%08x, val - 0x%08x\n", i,
+			(u32)&par_io->io_regs[i].cppar2,
+			in_be32(&par_io->io_regs[i].cppar2));
+	}
+
+	printk(KERN_INFO "QE PAR IO registars:\n");
+	printk(KERN_INFO "Base address: 0x%08x\n", (u32)qe_par_io);
+	printk(KERN_INFO "cepier : addr - 0x%08x, val - 0x%08x\n",
+		(u32)&qe_par_io->cepier, in_be32(&qe_par_io->cepier));
+	printk(KERN_INFO "cepimr : addr - 0x%08x, val - 0x%08x\n",
+		(u32)&qe_par_io->cepimr, in_be32(&qe_par_io->cepimr));
+	printk(KERN_INFO "cepicr : addr - 0x%08x, val - 0x%08x\n",
+		(u32)&qe_par_io->cepicr, in_be32(&qe_par_io->cepicr));
+}
+
+#ifdef CONFIG_PCI
+int mpc83xx_map_irq(struct pci_dev *dev, unsigned char idsel, unsigned char pin)
+{
+	static char pci_irq_table[][4] =
+	    /*
+	     *      PCI IDSEL/INTPIN->INTLINE
+	     *       A      B      C      D
+	     */
+	{
+		{PIRQA, PIRQB, PIRQC, PIRQD},	/* idsel 0x11 */
+		{PIRQC, PIRQD, PIRQA, PIRQB},	/* idsel 0x12 */
+		{PIRQD, PIRQA, PIRQB, PIRQC}	/* idsel 0x13 */
+	};
+
+	const long min_idsel = 0x11, max_idsel = 0x13, irqs_per_slot = 4;
+	return PCI_IRQ_TABLE_LOOKUP;
+}
+
+int mpc83xx_exclude_device(u_char bus, u_char devfn)
+{
+	if (bus == 0 && PCI_SLOT(devfn) == 0)
+		return PCIBIOS_DEVICE_NOT_FOUND;
+	return PCIBIOS_SUCCESSFUL;
+}
+#endif				/* CONFIG_PCI */
+
+/* ************************************************************************
+ *
+ * Setup the architecture
+ *
+ */
+static void __init
+mpc832xe_mds_setup_arch(void)
+{
+	bd_t                            *binfo = (bd_t *) __res;
+	unsigned int                    freq;
+	struct ucc_geth_platform_data   *pdata;
+	u8                              *bcsr_regs;
+
+	/* get the core frequency */
+	freq = binfo->bi_intfreq;
+
+	/* Set loops_per_jiffy to a half-way reasonable value,
+	   for use until calibrate_delay gets called. */
+	loops_per_jiffy = freq / HZ;
+
+#ifdef CONFIG_PCI
+	/* setup PCI host bridges */
+	mpc83xx_setup_hose();
+#endif /* CONFIG_PCI */
+	mpc83xx_early_serial_map();
+
+#ifdef CONFIG_QE
+	qe_reset();
+
+	/* setup the board related information for the enet3 controllers */
+	pdata = (struct ucc_geth_platform_data *) ppc_sys_get_pdata(MPC83xx_QE_UCC3);
+	pdata->device_flags &= ~FSL_UGETH_DEV_HAS_GIGABIT;
+	pdata->rx_clock      = QE_CLK9;
+	pdata->tx_clock      = QE_CLK10;
+	pdata->board_flags   = FSL_UGETH_BRD_HAS_PHY_INTR;
+	pdata->phy_id        = 3;
+	pdata->phy_interface = ENET_100_MII;
+	pdata->phy_interrupt = MPC83xx_IRQ_EXT1;
+	/* fixup phy address */
+	pdata->phy_reg_addr += QE_MAP_ADDR;
+	memcpy(pdata->mac_addr, binfo->bi_enetaddr, 6);
+
+	/* setup the board related information for the enet4 controllers */
+	pdata = (struct ucc_geth_platform_data *) ppc_sys_get_pdata(MPC83xx_QE_UCC4);
+	pdata->device_flags &= ~FSL_UGETH_DEV_HAS_GIGABIT;
+	pdata->rx_clock      = QE_CLK7;
+	pdata->tx_clock      = QE_CLK8;
+	pdata->board_flags   = FSL_UGETH_BRD_HAS_PHY_INTR;
+	pdata->phy_id        = 4;
+	pdata->phy_interface = ENET_100_MII;
+	pdata->phy_interrupt = MPC83xx_IRQ_EXT2;
+	/* fixup phy address */
+	pdata->phy_reg_addr += QE_MAP_ADDR;
+	memcpy(pdata->mac_addr, binfo->bi_enet1addr, 6);
+
+	par_io_config_pin(3,  4, 3, 0, 2, 0); /* MDIO */
+	par_io_config_pin(3,  5, 1, 0, 2, 0); /* MDC */
+
+	/* UCC3 */
+	par_io_config_pin(0, 13, 2, 0, 1, 0); /* RX_CLK (CLK9) */
+	par_io_config_pin(3, 24, 2, 0, 1, 0); /* TX_CLK (CLK10) */
+
+	par_io_config_pin(1,  0, 1, 0, 1, 0); /* TxD0 */
+	par_io_config_pin(1,  1, 1, 0, 1, 0); /* TxD1 */
+	par_io_config_pin(1,  2, 1, 0, 1, 0); /* TxD2 */
+	par_io_config_pin(1,  3, 1, 0, 1, 0); /* TxD3 */
+	par_io_config_pin(1,  4, 2, 0, 1, 0); /* RxD0 */
+	par_io_config_pin(1,  5, 2, 0, 1, 0); /* RxD1 */
+	par_io_config_pin(1,  6, 2, 0, 1, 0); /* RxD2 */
+	par_io_config_pin(1,  7, 2, 0, 1, 0); /* RxD3 */
+	par_io_config_pin(1,  8, 2, 0, 1, 0); /* RX_ER */
+	par_io_config_pin(1,  9, 1, 0, 1, 0); /* TX_ER */
+	par_io_config_pin(1, 10, 2, 0, 1, 0); /* RX_DV */
+	par_io_config_pin(1, 11, 2, 0, 1, 0); /* COL */
+	par_io_config_pin(1, 12, 1, 0, 1, 0); /* TX_EN */
+	par_io_config_pin(1, 13, 2, 0, 1, 0); /* CRS */
+
+	/* UCC4 */
+	par_io_config_pin(3, 31, 2, 0, 1, 0); /* RX_CLK (CLK7) */
+	par_io_config_pin(3,  6, 2, 0, 1, 0); /* TX_CLK (CLK8) */
+
+	par_io_config_pin(1, 18, 1, 0, 1, 0); /* TxD0 */
+	par_io_config_pin(1, 19, 1, 0, 1, 0); /* TxD1 */
+	par_io_config_pin(1, 20, 1, 0, 1, 0); /* TxD2 */
+	par_io_config_pin(1, 21, 1, 0, 1, 0); /* TxD3 */
+	par_io_config_pin(1, 22, 2, 0, 1, 0); /* RxD0 */
+	par_io_config_pin(1, 23, 2, 0, 1, 0); /* RxD1 */
+	par_io_config_pin(1, 24, 2, 0, 1, 0); /* RxD2 */
+	par_io_config_pin(1, 25, 2, 0, 1, 0); /* RxD3 */
+	par_io_config_pin(1, 26, 2, 0, 1, 0); /* RX_ER */
+	par_io_config_pin(1, 27, 1, 0, 1, 0); /* TX_ER */
+	par_io_config_pin(1, 28, 2, 0, 1, 0); /* RX_DV */
+	par_io_config_pin(1, 29, 2, 0, 1, 0); /* COL */
+	par_io_config_pin(1, 30, 1, 0, 1, 0); /* TX_EN */
+	par_io_config_pin(1, 31, 2, 0, 1, 0); /* CRS */
+
+	/* Reset the Ethernet PHY */
+	bcsr_regs = (u8 *)BCSR_VIRT_ADDR;
+	bcsr_regs[8] &= ~0x50;
+	udelay(1000);
+	bcsr_regs[8] |=  0x50;
+#endif /* CONFIG_QE */
+
+#ifdef CONFIG_BLK_DEV_INITRD
+	if (initrd_start)
+		ROOT_DEV = Root_RAM0;
+	else
+#endif
+#ifdef  CONFIG_ROOT_NFS
+		ROOT_DEV = Root_NFS;
+#else
+		ROOT_DEV = Root_HDA1;
+#endif
+}
+
+#if defined(CONFIG_MTD_PHYSMAP) && defined(CONFIG_MTD_PARTITIONS)
+
+/*
+ * The firmware doesn't seem to provide the correct FLASH values,
+ * hence these defines. They will most likely need to be updated for
+ * later boards.
+ */
+#define MPC832XMDS_FLASH_ADDR	0xfe000000
+#define MPC832XMDS_FLASH_SIZE	0x01000000
+#define MPC832XMDS_HRCW_SIZE	0x00020000
+#define MPC832XMDS_RAMDISK_SIZE	0x00400000
+#define MPC832XMDS_KRNL_SIZE	0x00200000
+#define MPC832XMDS_UBOOT_SIZE	0x00100000
+#define MPC832XMDS_FS_SIZE	(MPC832XMDS_FLASH_SIZE - \
+				 MPC832XMDS_HRCW_SIZE - \
+				 MPC832XMDS_KRNL_SIZE - \
+				 MPC832XMDS_RAMDISK_SIZE - \
+				 MPC832XMDS_UBOOT_SIZE)
+
+static struct mtd_partition ptbl[] = {
+	{
+	 .name = "Reset Configuration Word",
+	 .size = MPC832XMDS_HRCW_SIZE,
+	 .offset = 0,
+	 .mask_flags = MTD_WRITEABLE,
+	},
+	{
+	 .name = "User FS",
+	 .size = MPC832XMDS_FS_SIZE,
+	 .offset = MTDPART_OFS_APPEND,
+	 .mask_flags = 0,
+	},
+	{
+	 .name = "Ramdisk",
+	 .size = MPC832XMDS_RAMDISK_SIZE,
+	 .offset = MTDPART_OFS_APPEND,
+	 .mask_flags = 0,
+	 },
+	{
+	 .name = "Kernel",
+	 .size = MPC832XMDS_KRNL_SIZE,
+	 .offset = MTDPART_OFS_APPEND,
+	 .mask_flags = 0,
+	},
+	{
+	 .name = "ROM Monitor",
+	 .size = MTDPART_SIZ_FULL,
+	 .offset = MTDPART_OFS_APPEND,
+	 .mask_flags = MTD_WRITEABLE,
+	}
+};
+
+static int __init
+mpc832x_setup_mtd(void)
+{
+
+	physmap_configure(MPC832XMDS_FLASH_ADDR, MPC832XMDS_FLASH_SIZE, 2,
+			  NULL);
+
+	physmap_set_partitions(ptbl, sizeof(ptbl)/sizeof(ptbl[0]));
+	return 0;
+}
+
+arch_initcall(mpc832x_setup_mtd);
+#endif
+
+static void __init
+mpc832xe_mds_map_io(void)
+{
+	/* we steal the lowest ioremap addr for virt space */
+	io_block_mapping(VIRT_IMMRBAR, immrbar, MPC83xx_IMMRBAR_SIZE, _PAGE_IO);
+	io_block_mapping(BCSR_VIRT_ADDR, BCSR_PHYS_ADDR, BCSR_SIZE, _PAGE_IO);
+}
+
+int
+mpc832xe_mds_show_cpuinfo(struct seq_file *m)
+{
+	uint pvid, svid, phid1;
+	bd_t *binfo = (bd_t *) __res;
+	unsigned int freq;
+
+	/* get the core frequency */
+	freq = binfo->bi_intfreq;
+
+	pvid = mfspr(PVR);
+	svid = mfspr(SVR);
+
+	seq_printf(m, "chip\t\t: MPC%s\n", cur_ppc_sys_spec->ppc_sys_name);
+	seq_printf(m, "Vendor\t\t: Freescale Inc.\n");
+	seq_printf(m, "Machine\t\t: mpc%s sys\n", cur_ppc_sys_spec->ppc_sys_name);
+	seq_printf(m, "core clock\t: %d MHz\n"
+			"bus  clock\t: %d MHz\n",
+			(int)(binfo->bi_intfreq / 1000000),
+			(int)(binfo->bi_busfreq / 1000000));
+	seq_printf(m, "PVR\t\t: 0x%x\n", pvid);
+	seq_printf(m, "SVR\t\t: 0x%x\n", svid);
+
+	/* Display cpu Pll setting */
+	phid1 = mfspr(HID1);
+	seq_printf(m, "PLL setting\t: 0x%x\n", ((phid1 >> 24) & 0x3f));
+
+	/* Display the amount of memory */
+	seq_printf(m, "Memory\t\t: %d MB\n", (int)(binfo->bi_memsize / (1024 * 1024)));
+
+	return 0;
+}
+
+void __init
+mpc832xe_mds_init_IRQ(void)
+{
+	bd_t *binfo = (bd_t *) __res;
+
+	u8 senses[8] = {
+		0,			/* EXT 0 */
+		IRQ_SENSE_LEVEL,	/* EXT 1 */
+		IRQ_SENSE_LEVEL,	/* EXT 2 */
+		0,			/* EXT 3 */
+		IRQ_SENSE_LEVEL,	/* EXT 4 */
+		IRQ_SENSE_LEVEL,	/* EXT 5 */
+		IRQ_SENSE_LEVEL,	/* EXT 6 */
+		IRQ_SENSE_LEVEL,	/* EXT 7 */
+	};
+
+	ipic_init(binfo->bi_immr_base + 0x00700, 0, MPC83xx_IPIC_IRQ_OFFSET, senses, 8);
+
+	/* Initialize the default interrupt mapping priorities,
+	 * in case the boot rom changed something on us.
+	 */
+	ipic_set_default_priority();
+
+#ifdef CONFIG_QE
+	qe_ic_init(QE_MAP_ADDR + 0x00000080,
+			(QE_IC_LOW_SIGNAL | QE_IC_HIGH_SIGNAL), QE_IRQ_OFFSET);
+#endif /* CONFIG_QE */
+}
+
+#if defined(CONFIG_I2C_MPC) && defined(CONFIG_SENSORS_DS1374)
+extern ulong	ds1374_get_rtc_time(void);
+extern int	ds1374_set_rtc_time(ulong);
+
+static int __init
+mpc832x_rtc_hookup(void)
+{
+	struct timespec	tv;
+
+	ppc_md.get_rtc_time = ds1374_get_rtc_time;
+	ppc_md.set_rtc_time = ds1374_set_rtc_time;
+
+	tv.tv_nsec = 0;
+	tv.tv_sec = (ppc_md.get_rtc_time)();
+	do_settimeofday(&tv);
+
+	return 0;
+}
+late_initcall(mpc832x_rtc_hookup);
+#endif
+
+static __inline__ void
+mpc832xe_mds_set_bat(void)
+{
+	/* we steal the lowest ioremap addr for virt space */
+	mb();
+	mtspr(DBAT1U, VIRT_IMMRBAR | 0x3e);
+	mtspr(DBAT1L, immrbar | 0x2a);
+	mb();
+}
+
+void __init
+platform_init(unsigned long r3, unsigned long r4, unsigned long r5,
+	      unsigned long r6, unsigned long r7)
+{
+	bd_t *binfo = (bd_t *) __res;
+
+	/* parse_bootinfo must always be called first */
+	parse_bootinfo(find_bootinfo());
+
+	/*
+	 * If we were passed in a board information, copy it into the
+	 * residual data area.
+	 */
+	if (r3) {
+		memcpy((void *) __res, (void *) (r3 + KERNELBASE),
+		       sizeof (bd_t));
+	}
+
+#if defined(CONFIG_BLK_DEV_INITRD)
+	/*
+	 * If the init RAM disk has been configured in, and there's a valid
+	 * starting address for it, set it up.
+	 */
+	if (r4) {
+		initrd_start = r4 + KERNELBASE;
+		initrd_end = r5 + KERNELBASE;
+	}
+#endif /* CONFIG_BLK_DEV_INITRD */
+
+	/* Copy the kernel command line arguments to a safe place. */
+	if (r6) {
+		*(char *) (r7 + KERNELBASE) = 0;
+		strcpy(cmd_line, (char *) (r6 + KERNELBASE));
+	}
+
+	immrbar = binfo->bi_immr_base;
+
+	mpc832xe_mds_set_bat();
+
+#if defined(CONFIG_SERIAL_8250) && defined(CONFIG_SERIAL_TEXT_DEBUG)
+	{
+		struct uart_port p;
+
+		memset(&p, 0, sizeof (p));
+		p.iotype = SERIAL_IO_MEM;
+		p.membase = (unsigned char __iomem *)(VIRT_IMMRBAR + 0x4500);
+		p.uartclk = binfo->bi_busfreq;
+
+		gen550_init(0, &p);
+
+		memset(&p, 0, sizeof (p));
+		p.iotype = SERIAL_IO_MEM;
+		p.membase = (unsigned char __iomem *)(VIRT_IMMRBAR + 0x4600);
+		p.uartclk = binfo->bi_busfreq;
+
+		gen550_init(1, &p);
+	}
+#endif
+
+	identify_ppc_sys_by_id(mfspr(SVR));
+
+	/* setup the PowerPC module struct */
+	ppc_md.setup_arch = mpc832xe_mds_setup_arch;
+	ppc_md.show_cpuinfo = mpc832xe_mds_show_cpuinfo;
+
+	ppc_md.init_IRQ = mpc832xe_mds_init_IRQ;
+	ppc_md.get_irq = ipic_get_irq;
+
+	ppc_md.restart = mpc83xx_restart;
+	ppc_md.power_off = mpc83xx_power_off;
+	ppc_md.halt = mpc83xx_halt;
+
+	ppc_md.find_end_of_memory = mpc83xx_find_end_of_memory;
+	ppc_md.setup_io_mappings  = mpc832xe_mds_map_io;
+
+	ppc_md.time_init = mpc83xx_time_init;
+	ppc_md.set_rtc_time = NULL;
+	ppc_md.get_rtc_time = NULL;
+	ppc_md.calibrate_decr = mpc83xx_calibrate_decr;
+
+#if defined(CONFIG_SERIAL_8250) && defined(CONFIG_SERIAL_TEXT_DEBUG)
+	ppc_md.progress = gen550_progress;
+#endif	/* CONFIG_SERIAL_8250 && CONFIG_SERIAL_TEXT_DEBUG */
+
+	if (ppc_md.progress)
+		ppc_md.progress("mpc832xe_mds_init(): exit", 0);
+
+	return;
+}
Index: linux-2.6.10/arch/ppc/platforms/83xx/mpc832xe_mds.h
===================================================================
--- /dev/null
+++ linux-2.6.10/arch/ppc/platforms/83xx/mpc832xe_mds.h
@@ -0,0 +1,39 @@
+/*
+ * arch/ppc/platforms/83xx/mpc832xe_mds.h
+ *
+ * Description: MPC832XE MDS common board definitions
+ *
+ * Author: Shlomi Gridish <gridish@freescale.com>
+ *
+ * Copyright (C) Freescale Semiconductor, Inc. 2005. All rights reserved.
+ *
+ * This program is free software; you can redistribute  it and/or modify it
+ * under  the terms of  the GNU General  Public License as published by the
+ * Free Software Foundation;  either version 2 of the  License, or (at your
+ * option) any later version.
+ *
+ */
+
+#ifndef __MPC832XE_MDS_H__
+#define __MPC832XE_MDS_H__
+
+#include <linux/config.h>
+#include <linux/init.h>
+#include <linux/seq_file.h>
+#include <syslib/ppc83xx_setup.h>
+#include <asm/ppcboot.h>
+
+#define VIRT_IMMRBAR		((uint)0xfe000000)
+
+#define BCSR_PHYS_ADDR		((uint)0xf8000000)
+#define BCSR_VIRT_ADDR		((uint)0xfe200000)
+#define BCSR_SIZE			((uint)(128 * 1024))
+
+#define QE_MAP_ADDR			((uint)immrbar + 0x100000)
+
+#define PIRQA	MPC83xx_IRQ_EXT4
+#define PIRQB	MPC83xx_IRQ_EXT5
+#define PIRQC	MPC83xx_IRQ_EXT6
+#define PIRQD	MPC83xx_IRQ_EXT7
+
+#endif /* __MPC832XE_MDS_H__ */
Index: linux-2.6.10/arch/ppc/qe_io/qe_common.c
===================================================================
--- linux-2.6.10.orig/arch/ppc/qe_io/qe_common.c
+++ linux-2.6.10/arch/ppc/qe_io/qe_common.c
@@ -98,8 +98,7 @@ int qe_issue_cmd(uint cmd, uint device, 
 				mcn_shift = QE_CR_MCN_NORMAL_SHIFT;
 		}
 
-		out_be32(&qe_immr->cp.cecdr,
-			 immrbar_virt_to_phys((void *)cmd_input));
+		out_be32(&qe_immr->cp.cecdr, cmd_input);
 		out_be32(&qe_immr->cp.cecr,
 			 (cmd | QE_CR_FLG | ((u32) device << dev_shift) | (u32)
 			  mcn_protocol << mcn_shift));
Index: linux-2.6.10/arch/ppc/qe_io/ucc/ucc_fast.c
===================================================================
--- linux-2.6.10.orig/arch/ppc/qe_io/ucc/ucc_fast.c
+++ linux-2.6.10/arch/ppc/qe_io/ucc/ucc_fast.c
@@ -229,7 +229,7 @@ int ucc_fast_init(ucc_fast_info_t * uf_i
 					   GFP_KERNEL);
 	if (!uccf) {
 		uccf_err
-		    ("ucc_fast_init: No memory for UCC slow data structure!");
+		    ("ucc_fast_init: No memory for UCC fast data structure!");
 		return -ENOMEM;
 	}
 	memset(uccf, 0, sizeof(ucc_fast_private_t));
@@ -241,7 +241,7 @@ int ucc_fast_init(ucc_fast_info_t * uf_i
 	    (ucc_fast_t *) ioremap(uf_info->regs, sizeof(ucc_fast_t));
 	if (uccf->uf_regs == NULL) {
 		uccf_err
-		    ("ucc_fast_init: No memory map for UCC slow controller!");
+		    ("ucc_fast_init: No memory map for UCC fast controller!");
 		return -ENOMEM;
 	}
 
Index: linux-2.6.10/arch/ppc/syslib/mpc832x_pci.h
===================================================================
--- /dev/null
+++ linux-2.6.10/arch/ppc/syslib/mpc832x_pci.h
@@ -0,0 +1,237 @@
+/* arch/ppc/syslib/mpc832x_pci.h
+ *
+ * Description: MPC832x PCI controller define
+ *
+ * Author: Olivia Yin (r63875@freescale.com)
+ *
+ * Copyright (C) Freescale Semiconductor, Inc. 2005. All rights reserved.
+ *
+ * This program is free software; you can redistribute  it and/or modify it
+ * under  the terms of  the GNU General  Public License as published by the
+ * Free Software Foundation;  either version 2 of the  License, or (at your
+ * option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful, but
+ * WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * General Public License for more details.
+ *
+ * You should have received a copy of the  GNU General Public License along
+ * with this program; if not, write  to the Free Software Foundation, Inc.,
+ * 675 Mass Ave, Cambridge, MA 02139, USA.
+ */
+
+#ifndef __MPC832X_PCI_H__
+#define __MPC832X_PCI_H__
+
+/*
+ * Local Access Window.
+ */
+typedef struct law832x {
+	u32	bar; /* LBIU local access window base address register */
+	u32 	ar;  /* LBIU local access window attribute register */
+} law832x_t;
+
+#define	LAWBAR_BAR	0xFFFFF000 /* Identifies the 20 most-significant address bits of the base of local access window n. The specified base address should be aligned to the window size, as defined by LBLAWARn[SIZE]. */
+#define	LAWBAR_RES	~(LAWBAR_BAR)
+#define	LAWAR_EN	0x80000000 /* 0 The local bus local access window n is disabled. 1 The local bus local access window n is enabled and other LBLAWAR0 and LBLAWBAR0 fields combine to identify an address range for this window. */
+#define	LAWAR_SIZE	0x0000003F /* Identifies the size of the window from the starting address. Window size is 2^(SIZE+1) bytes. 000000001010Reserved. Window is undefined. */
+#define	LAWAR_SIZE_4K	0x0000000B
+#define	LAWAR_SIZE_8K	0x0000000C
+#define	LAWAR_SIZE_16K	0x0000000D
+#define	LAWAR_SIZE_32K	0x0000000E
+#define	LAWAR_SIZE_64K	0x0000000F
+#define	LAWAR_SIZE_128K	0x00000010
+#define	LAWAR_SIZE_256K	0x00000011
+#define	LAWAR_SIZE_512K	0x00000012
+#define	LAWAR_SIZE_1M	0x00000013
+#define	LAWAR_SIZE_2M	0x00000014
+#define	LAWAR_SIZE_4M	0x00000015
+#define	LAWAR_SIZE_8M	0x00000016
+#define	LAWAR_SIZE_16M	0x00000017
+#define	LAWAR_SIZE_32M	0x00000018
+#define	LAWAR_SIZE_64M	0x00000019
+#define	LAWAR_SIZE_128M	0x0000001A
+#define	LAWAR_SIZE_256M	0x0000001B
+#define	LAWAR_SIZE_512M	0x0000001C
+#define	LAWAR_SIZE_1G	0x0000001D
+#define	LAWAR_SIZE_2G	0x0000001E
+#define	LAWAR_RES	~(LAWAR_EN|LAWAR_SIZE)
+
+/*
+ * Clock Configuration Register
+ */
+typedef struct clk832x {
+	u32	spmr; /* system PLL mode Register  */
+	u32	occr; /* output clock control Register  */
+	u32	sccr; /* system clock control Register  */
+	u8	res0[0xF4];
+} clk832x_t;
+
+#define	OCCR_PCICOE0	0x80000000 /* PCICOE0  */
+#define	OCCR_PCICOE1	0x40000000 /* PCICOE1  */
+#define	OCCR_PCICOE2	0x20000000 /* PCICOE2  */
+
+/*
+ * PCI Outbound Translation Register
+ */
+typedef struct pci_outbound_window {
+	u32	potar;
+	u8	res0[4];
+	u32	pobar;
+	u8	res1[4];
+	u32	pocmr;
+	u8	res2[4];
+} pot832x_t;
+
+#define	POTAR_TA_MASK	0x000fffff
+#define	POBAR_BA_MASK	0x000fffff
+#define	POCMR_EN	0x80000000
+#define	POCMR_IO	0x40000000	/* 0--memory space 1--I/O space */
+#define	POCMR_SE	0x20000000	/* streaming enable */
+#define	POCMR_DST	0x10000000	/* 0--PCI1 1--PCI2*/
+#define	POCMR_CM_MASK	0x000fffff
+#define	POCMR_CM_4G	0x00000000
+#define	POCMR_CM_2G	0x00080000
+#define	POCMR_CM_1G	0x000C0000
+#define	POCMR_CM_512M	0x000E0000
+#define	POCMR_CM_256M	0x000F0000
+#define	POCMR_CM_128M	0x000F8000
+#define	POCMR_CM_64M	0x000FC000
+#define	POCMR_CM_32M	0x000FE000
+#define	POCMR_CM_16M	0x000FF000
+#define	POCMR_CM_8M	0x000FF800
+#define	POCMR_CM_4M	0x000FFC00
+#define	POCMR_CM_2M	0x000FFE00
+#define	POCMR_CM_1M	0x000FFF00
+#define	POCMR_CM_512K	0x000FFF80
+#define	POCMR_CM_256K	0x000FFFC0
+#define	POCMR_CM_128K	0x000FFFE0
+#define	POCMR_CM_64K	0x000FFFF0
+#define	POCMR_CM_32K	0x000FFFF8
+#define	POCMR_CM_16K	0x000FFFFC
+#define	POCMR_CM_8K	0x000FFFFE
+#define	POCMR_CM_4K	0x000FFFFF
+
+/*
+ * PCI Controller Control and Status Registers
+ */
+typedef struct pcictrl832x {
+	u32	esr;
+	u32	ecdr;
+	u32 	eer;
+	u32	eatcr;
+	u32	eacr;
+	u32	eeacr;
+	u32	edcr;
+	u8	res0[4];
+	u32	gcr;
+	u32	ecr;
+	u32	gsr;
+	u8	res1[12];
+	u32	pitar2;
+	u8	res2[4];
+	u32	pibar2;
+	u32	piebar2;
+	u32	piwar2;
+	u8	res3[4];
+	u32	pitar1;
+	u8	res4[4];
+	u32	pibar1;
+	u32	piebar1;
+	u32	piwar1;
+	u8	res5[4];
+	u32	pitar0;
+	u8	res6[4];
+	u32	pibar0;
+	u8	res7[4];
+	u32	piwar0;
+	u8	res8[132];
+} pcictrl832x_t;
+
+#define	ESR_MERR	0x80000000
+#define	ESR_APAR	0x00000400
+#define	ESR_PCISERR	0x00000200
+#define	ESR_MPERR	0x00000100
+#define	ESR_TPERR	0x00000080
+#define	ESR_NORSP	0x00000040
+#define	ESR_TABT	0x00000020
+#define	ECDR_APAR	0x00000400
+#define	ECDR_PCISERR	0x00000200
+#define	ECDR_MPERR	0x00000100
+#define	ECDR_TPERR	0x00000080
+#define	ECDR_NORSP	0x00000040
+#define	ECDR_TABT	0x00000020
+#define	EER_APAR	0x00000400
+#define	EER_PCISERR	0x00000200
+#define	EER_MPERR	0x00000100
+#define	EER_TPERR	0x00000080
+#define	EER_NORSP	0x00000040
+#define	EER_TABT	0x00000020
+#define	EATCR_ERRTYPR_MASK	0x70000000
+#define	EATCR_ERRTYPR_APR	0x00000000	/* address parity error */
+#define	EATCR_ERRTYPR_WDPR	0x10000000	/* write data parity error */
+#define	EATCR_ERRTYPR_RDPR	0x20000000	/* read data parity error */
+#define	EATCR_ERRTYPR_MA	0x30000000	/* master abort */
+#define	EATCR_ERRTYPR_TA	0x40000000	/* target abort */
+#define	EATCR_ERRTYPR_SE	0x50000000	/* system error indication received */
+#define	EATCR_ERRTYPR_PEA	0x60000000	/* parity error indication received on a read */
+#define	EATCR_ERRTYPR_PEW	0x70000000	/* parity error indication received on a write */
+#define	EATCR_BN_MASK	0x0f000000	/* beat number */
+#define	EATCR_BN_1st	0x00000000
+#define	EATCR_BN_2ed	0x01000000
+#define	EATCR_BN_3rd	0x02000000
+#define	EATCR_BN_4th	0x03000000
+#define	EATCR_BN_5th	0x0400000
+#define	EATCR_BN_6th	0x05000000
+#define	EATCR_BN_7th	0x06000000
+#define	EATCR_BN_8th	0x07000000
+#define	EATCR_BN_9th	0x08000000
+#define	EATCR_TS_MASK	0x00300000	/* transaction size */
+#define	EATCR_TS_4	0x00000000
+#define	EATCR_TS_1	0x00100000
+#define	EATCR_TS_2	0x00200000
+#define	EATCR_TS_3	0x00300000
+#define	EATCR_ES_MASK	0x000f0000	/* error source */
+#define	EATCR_ES_EM	0x00000000	/* external master */
+#define	EATCR_ES_DMA	0x00050000
+#define	EATCR_CMD_MASK	0x0000f000
+#define	EATCR_HBE_MASK	0x00000f00	/* PCI high byte enable*/
+#define	EATCR_BE_MASK	0x000000f0	/* PCI byte enable */
+#define	EATCR_HPB	0x00000004	/* high parity bit */
+#define	EATCR_PB	0x00000002	/* parity bit*/
+#define	EATCR_VI	0x00000001	/* error information valid */
+#define	PITAR_TA_MASK	0x000fffff
+#define	PIBAR_MASK	0xffffffff
+#define	PIEBAR_EBA_MASK	0x000fffff
+#define	PIWAR_EN	0x80000000
+#define	PIWAR_PF	0x20000000
+#define	PIWAR_RTT_MASK	0x000f0000
+#define	PIWAR_RTT_NO_SNOOP	0x00040000
+#define	PIWAR_RTT_SNOOP	0x00050000
+#define	PIWAR_WTT_MASK	0x0000f000
+#define	PIWAR_WTT_NO_SNOOP	0x00004000
+#define	PIWAR_WTT_SNOOP	0x00005000
+#define	PIWAR_IWS_MASK	0x0000003F
+#define	PIWAR_IWS_4K	0x0000000B
+#define	PIWAR_IWS_8K	0x0000000C
+#define	PIWAR_IWS_16K	0x0000000D
+#define	PIWAR_IWS_32K	0x0000000E
+#define	PIWAR_IWS_64K	0x0000000F
+#define	PIWAR_IWS_128K	0x00000010
+#define	PIWAR_IWS_256K	0x00000011
+#define	PIWAR_IWS_512K	0x00000012
+#define	PIWAR_IWS_1M	0x00000013
+#define	PIWAR_IWS_2M	0x00000014
+#define	PIWAR_IWS_4M	0x00000015
+#define	PIWAR_IWS_8M	0x00000016
+#define	PIWAR_IWS_16M	0x00000017
+#define	PIWAR_IWS_32M	0x00000018
+#define	PIWAR_IWS_64M	0x00000019
+#define	PIWAR_IWS_128M	0x0000001A
+#define	PIWAR_IWS_256M	0x0000001B
+#define	PIWAR_IWS_512M	0x0000001C
+#define	PIWAR_IWS_1G	0x0000001D
+#define	PIWAR_IWS_2G	0x0000001E
+
+#endif /*__MPC832X_PCI_H__*/
Index: linux-2.6.10/arch/ppc/syslib/mpc83xx_devices.c
===================================================================
--- linux-2.6.10.orig/arch/ppc/syslib/mpc83xx_devices.c
+++ linux-2.6.10/arch/ppc/syslib/mpc83xx_devices.c
@@ -88,6 +88,16 @@ static struct ucc_geth_platform_data mpc
 	.phy_reg_addr = 0x3000,
 };
 
+static struct ucc_geth_platform_data mpc83xx_ugeth3_pdata = {
+	.device_flags = FSL_UGETH_DEV_HAS_GIGABIT,
+	.phy_reg_addr = 0x2200,
+};
+
+static struct ucc_geth_platform_data mpc83xx_ugeth4_pdata = {
+	.device_flags = FSL_UGETH_DEV_HAS_GIGABIT,
+	.phy_reg_addr = 0x3200,
+};
+
 static struct cfide_platform_data cfide_pdata = {
 	.byte_lanes_swapping	= 0,
 	.regaddr_step		= 2,
@@ -293,11 +303,17 @@ struct platform_device ppc_sys_platform_
 		},
 	},
 	[MPC83xx_QE_UCC3] = {
-		.name = "fsl-ucc-atm",
-		.id = 0,
-		.num_resources = 1,
+		.name = "fsl-ucc-geth",
+		.id	= 2,
+		.dev.platform_data = &mpc83xx_ugeth3_pdata,
+		.num_resources = 2,
 		.resource = (struct resource[]) {
 			{
+				.start	= 0x102200,
+				.end	= 0x1023ff,
+				.flags	= IORESOURCE_MEM,
+			},
+			{
 				.name	= "ucc3-irq",
 				.start	= MPC83xx_QE_IRQ_UCC3,
 				.end	= MPC83xx_QE_IRQ_UCC3,
@@ -305,6 +321,25 @@ struct platform_device ppc_sys_platform_
 			},
 		},
 	},
+	[MPC83xx_QE_UCC4] = {
+		.name = "fsl-ucc-geth",
+		.id	= 3,
+		.dev.platform_data = &mpc83xx_ugeth4_pdata,
+		.num_resources = 2,
+		.resource = (struct resource[]) {
+			{
+				.start	= 0x103200,
+				.end	= 0x1033ff,
+				.flags	= IORESOURCE_MEM,
+			},
+			{
+				.name	= "ucc4-irq",
+				.start	= MPC83xx_QE_IRQ_UCC4,
+				.end	= MPC83xx_QE_IRQ_UCC4,
+				.flags	= IORESOURCE_IRQ,
+			},
+		},
+	},
 	[MPC83xx_MDIO] = {
 		.name = "fsl-gianfar_mdio",
 		.id = 0,
@@ -361,6 +396,60 @@ struct platform_device ppc_sys_platform_
 			},
 		},
 	},
+	[MPC83xx_QE_SPI1] = {
+		.name = "fsl-qe-spi1",
+		.id	= 1,
+		.num_resources	 = 2,
+		.resource = (struct resource[]) {
+			{
+				.start	= 0x1004c0,
+				.end	= 0x1004ff,
+				.flags	= IORESOURCE_MEM,
+			},
+			{
+				.name	= "qe-spi1-irq",
+				.start	= MPC83xx_QE_IRQ_SPI1,
+				.end	= MPC83xx_QE_IRQ_SPI1,
+				.flags	= IORESOURCE_IRQ,
+			},
+		},
+	},
+	[MPC83xx_QE_SPI2] = {
+		.name = "fsl-qe-spi2",
+		.id	= 1,
+		.num_resources	 = 2,
+		.resource = (struct resource[]) {
+			{
+				.start	= 0x100500,
+				.end	= 0x10053f,
+				.flags	= IORESOURCE_MEM,
+			},
+			{
+				.name	= "qe-spi2-irq",
+				.start	= MPC83xx_QE_IRQ_SPI2,
+				.end	= MPC83xx_QE_IRQ_SPI2,
+				.flags	= IORESOURCE_IRQ,
+			},
+		},
+	},
+	[MPC83xx_QE_USB] = {
+		.name = "fsl-qe-usb",
+		.id     = 0,
+		.num_resources   = 2,
+		.resource = (struct resource[]) {
+			{
+				.start  = 0x1006c0,
+				.end    = 0x1006ff,
+				.flags  = IORESOURCE_MEM,
+			},
+			{
+				.name   = "usb-irq",
+				.start  = MPC83xx_QE_IRQ_USB,
+				.end    = MPC83xx_QE_IRQ_USB,
+				.flags  = IORESOURCE_IRQ,
+			},
+		},
+	},
 };
 
 static int __init mach_mpc83xx_fixup(struct platform_device *pdev)
Index: linux-2.6.10/arch/ppc/syslib/mpc83xx_sys.c
===================================================================
--- linux-2.6.10.orig/arch/ppc/syslib/mpc83xx_sys.c
+++ linux-2.6.10/arch/ppc/syslib/mpc83xx_sys.c
@@ -82,63 +82,109 @@ struct ppc_sys_spec ppc_sys_specs[] = {
 		},
 	},
 	{
-		.ppc_sys_name	= "8347E",
+		.ppc_sys_name	= "8343E",
 		.mask 		= 0xFFFF0000,
 		.value 		= 0x80540000,
-		.num_devices	= 9,
+		.num_devices	= 8,
 		.device_list	= (enum ppc_sys_devices[])
 		{
 			MPC83xx_TSEC1, MPC83xx_TSEC2, MPC83xx_IIC1,
 			MPC83xx_IIC2, MPC83xx_DUART, MPC83xx_SEC2,
-			MPC83xx_USB2_DR, MPC83xx_USB2_MPH, MPC83xx_MDIO
+			MPC83xx_USB2_DR, MPC83xx_MDIO
 		},
 	},
 	{
-		.ppc_sys_name	= "8347",
+		.ppc_sys_name	= "8343",
 		.mask 		= 0xFFFF0000,
 		.value 		= 0x80550000,
-		.num_devices	= 8,
+		.num_devices	= 7,
 		.device_list	= (enum ppc_sys_devices[])
 		{
 			MPC83xx_TSEC1, MPC83xx_TSEC2, MPC83xx_IIC1,
 			MPC83xx_IIC2, MPC83xx_DUART,
-			MPC83xx_USB2_DR, MPC83xx_USB2_MPH, MPC83xx_MDIO
+			MPC83xx_USB2_DR, MPC83xx_MDIO
 		},
 	},
 	{
-		.ppc_sys_name	= "8343E",
-		.mask 		= 0xFFFF0000,
-		.value 		= 0x80560000,
-		.num_devices	= 8,
+		.ppc_sys_name	= "8360E",
+		.mask		= 0xFFFF0000,
+		.value		= 0x80480000,
+		.num_devices	= 5,
 		.device_list	= (enum ppc_sys_devices[])
 		{
-			MPC83xx_TSEC1, MPC83xx_TSEC2, MPC83xx_IIC1,
-			MPC83xx_IIC2, MPC83xx_DUART, MPC83xx_SEC2,
-			MPC83xx_USB2_DR, MPC83xx_MDIO
+			MPC83xx_QE_UCC1,MPC83xx_QE_UCC2,
+			MPC83xx_IIC1, MPC83xx_IIC2, MPC83xx_DUART,
+
 		},
 	},
 	{
-		.ppc_sys_name	= "8343",
-		.mask 		= 0xFFFF0000,
-		.value 		= 0x80570000,
+		.ppc_sys_name	= "8325E",
+		.mask		= 0xFFFF0000,
+		.value		= 0x80680000,
 		.num_devices	= 7,
 		.device_list	= (enum ppc_sys_devices[])
 		{
-			MPC83xx_TSEC1, MPC83xx_TSEC2, MPC83xx_IIC1,
-			MPC83xx_IIC2, MPC83xx_DUART,
-			MPC83xx_USB2_DR, MPC83xx_MDIO
+			MPC83xx_IIC1, MPC83xx_DUART,
+			MPC83xx_QE_UCC3, MPC83xx_QE_UCC4,
+			MPC83xx_QE_SPI1, MPC83xx_QE_SPI2, MPC83xx_QE_USB,
 		},
 	},
 	{
-		.ppc_sys_name	= "8360E",
+		.ppc_sys_name	= "8325",
 		.mask		= 0xFFFF0000,
-		.value		= 0x80480000,
-		.num_devices	= 6,
+		.value		= 0x80690000,
+		.num_devices	= 7,
 		.device_list	= (enum ppc_sys_devices[])
 		{
-			MPC83xx_QE_UCC1,MPC83xx_QE_UCC2,MPC83xx_QE_UCC3,
-			MPC83xx_IIC1, MPC83xx_IIC2, MPC83xx_DUART,
-
+			MPC83xx_IIC1, MPC83xx_DUART,
+			MPC83xx_QE_UCC3, MPC83xx_QE_UCC4,
+			MPC83xx_QE_SPI1, MPC83xx_QE_SPI2, MPC83xx_QE_USB,
+		},
+	},
+	{
+		.ppc_sys_name	= "8323E",
+		.mask		= 0xFFFF0000,
+		.value		= 0x80620000,
+		.num_devices	= 7,
+		.device_list	= (enum ppc_sys_devices[])
+		{
+			MPC83xx_IIC1, MPC83xx_DUART,
+			MPC83xx_QE_UCC3, MPC83xx_QE_UCC4,
+			MPC83xx_QE_SPI1, MPC83xx_QE_SPI2, MPC83xx_QE_USB,
+		},
+	},
+	{
+		.ppc_sys_name	= "8323",
+		.mask		= 0xFFFF0000,
+		.value		= 0x80630000,
+		.num_devices	= 7,
+		.device_list	= (enum ppc_sys_devices[])
+		{
+			MPC83xx_IIC1, MPC83xx_DUART,
+			MPC83xx_QE_UCC3, MPC83xx_QE_UCC4,
+			MPC83xx_QE_SPI1, MPC83xx_QE_SPI2, MPC83xx_QE_USB,
+		},
+	},
+	{
+		.ppc_sys_name	= "8321E",
+		.mask		= 0xFFFF0000,
+		.value		= 0x80660000,
+		.num_devices	= 4,
+		.device_list	= (enum ppc_sys_devices[])
+		{
+			MPC83xx_IIC1, MPC83xx_DUART,
+			MPC83xx_QE_UCC3, MPC83xx_QE_UCC4,
+		},
+	},
+	{
+		.ppc_sys_name	= "8321",
+		.mask		= 0xFFFF0000,
+		.value		= 0x80670000,
+		.num_devices	= 4,
+		.device_list	= (enum ppc_sys_devices[])
+		{
+			MPC83xx_IIC1, MPC83xx_DUART,
+			MPC83xx_QE_UCC3, MPC83xx_QE_UCC4,
 		},
 	},
 	{	/* default match */
Index: linux-2.6.10/arch/ppc/syslib/ppc83xx_pci.h
===================================================================
--- linux-2.6.10.orig/arch/ppc/syslib/ppc83xx_pci.h
+++ linux-2.6.10/arch/ppc/syslib/ppc83xx_pci.h
@@ -27,7 +27,7 @@ typedef struct law {
 #define	LAWBAR_BAR	0xFFFFF000 /* Identifies the 20 most-significant address bits of the base of local access window n. The specified base address should be aligned to the window size, as defined by LBLAWARn[SIZE]. */
 #define	LAWBAR_RES	~(LAWBAR_BAR)
 #define	LAWAR_EN	0x80000000 /* 0 The local bus local access window n is disabled. 1 The local bus local access window n is enabled and other LBLAWAR0 and LBLAWBAR0 fields combine to identify an address range for this window. */
-#define	LAWAR_SIZE	0x0000003F /* Identifies the size of the window from the starting address. Window size is 2^(SIZE+1) bytes. 000000001010Reserved. Window is undefined. */
+#define	LAWAR_SIZE	0x0000003F /* Identifies the size of the window from the starting address. Window size is 2^(SIZE+1) bytes. 000000-001010 Reserved. Window is undefined. */
 #define	LAWAR_SIZE_4K	0x0000000B
 #define	LAWAR_SIZE_8K	0x0000000C
 #define	LAWAR_SIZE_16K	0x0000000D
Index: linux-2.6.10/include/asm-ppc/mpc83xx.h
===================================================================
--- linux-2.6.10.orig/include/asm-ppc/mpc83xx.h
+++ linux-2.6.10/include/asm-ppc/mpc83xx.h
@@ -34,6 +34,9 @@
 #ifdef CONFIG_MPC8360E_PB
 #include <platforms/83xx/mpc8360e_pb.h>
 #endif
+#ifdef CONFIG_MPC832XE_MDS
+#include <platforms/83xx/mpc832xe_mds.h>
+#endif
 
 #define _IO_BASE        isa_io_base
 #define _ISA_MEM_BASE   isa_mem_base
@@ -131,14 +134,17 @@ extern unsigned char __res[];
 
 #define MPC83xx_NR_QE_IC_INTS 64
 
-#define MPC83xx_QE_IRQ_UCC1             (32 + MPC83xx_QE_IRQ_OFFSET)
-#define MPC83xx_QE_IRQ_UCC2             (33 + MPC83xx_QE_IRQ_OFFSET)
-#define MPC83xx_QE_IRQ_UCC3             (34 + MPC83xx_QE_IRQ_OFFSET)
-#define MPC83xx_QE_IRQ_UCC4             (35 + MPC83xx_QE_IRQ_OFFSET)
-#define MPC83xx_QE_IRQ_UCC5             (40 + MPC83xx_QE_IRQ_OFFSET)
-#define MPC83xx_QE_IRQ_UCC6             (41 + MPC83xx_QE_IRQ_OFFSET)
-#define MPC83xx_QE_IRQ_UCC7             (42 + MPC83xx_QE_IRQ_OFFSET)
-#define MPC83xx_QE_IRQ_UCC8             (43 + MPC83xx_QE_IRQ_OFFSET)
+#define MPC83xx_QE_IRQ_SPI2		(1 + MPC83xx_QE_IRQ_OFFSET)
+#define MPC83xx_QE_IRQ_SPI1		(2 + MPC83xx_QE_IRQ_OFFSET)
+#define MPC83xx_QE_IRQ_USB		(11 + MPC83xx_QE_IRQ_OFFSET)
+#define MPC83xx_QE_IRQ_UCC1		(32 + MPC83xx_QE_IRQ_OFFSET)
+#define MPC83xx_QE_IRQ_UCC2		(33 + MPC83xx_QE_IRQ_OFFSET)
+#define MPC83xx_QE_IRQ_UCC3		(34 + MPC83xx_QE_IRQ_OFFSET)
+#define MPC83xx_QE_IRQ_UCC4		(35 + MPC83xx_QE_IRQ_OFFSET)
+#define MPC83xx_QE_IRQ_UCC5		(40 + MPC83xx_QE_IRQ_OFFSET)
+#define MPC83xx_QE_IRQ_UCC6		(41 + MPC83xx_QE_IRQ_OFFSET)
+#define MPC83xx_QE_IRQ_UCC7		(42 + MPC83xx_QE_IRQ_OFFSET)
+#define MPC83xx_QE_IRQ_UCC8		(43 + MPC83xx_QE_IRQ_OFFSET)
 
 #ifdef CONFIG_QE
 #define MPC83xx_IMMRBAR_SIZE    (2*1024*1024)
@@ -201,6 +207,9 @@ enum ppc_sys_devices {
 	MPC83xx_QE_UCC6,
 	MPC83xx_QE_UCC7,
 	MPC83xx_QE_UCC8,
+	MPC83xx_QE_SPI1,
+	MPC83xx_QE_SPI2,
+	MPC83xx_QE_USB,
 	NUM_PPC_SYS_DEVS,
 };
 
Index: linux-2.6.10/include/asm-ppc/qe.h
===================================================================
--- linux-2.6.10.orig/include/asm-ppc/qe.h
+++ linux-2.6.10/include/asm-ppc/qe.h
@@ -22,7 +22,11 @@
  */
 #define QE_MURAM_DATAONLY_BASE	((uint)0x0)
 #define QE_MURAM_NOSPACE		((uint)0x7fffffff)
+#if defined(CONFIG_MPC8360)
 #define QE_MURAM_DATAONLY_SIZE	((uint)(48 * 1024) - QE_MURAM_DATAONLY_BASE)
+#elif defined(CONFIG_MPC832X)
+#define QE_MURAM_DATAONLY_SIZE ((uint)(16 * 1024) - QE_MURAM_DATAONLY_BASE)
+#endif
 
 static inline long IS_MURAM_ERR(const uint offset)
 {
Index: linux-2.6.10/mvl_patches/pro-1339.c
===================================================================
--- /dev/null
+++ linux-2.6.10/mvl_patches/pro-1339.c
@@ -0,0 +1,16 @@
+/*
+ * Author: MontaVista Software, Inc. <source@mvista.com>
+ *
+ * 2007 (c) MontaVista Software, Inc. This file is licensed under
+ * the terms of the GNU General Public License version 2. This program
+ * is licensed "as is" without any warranty of any kind, whether express
+ * or implied.
+ */
+#include <linux/init.h>
+#include <linux/mvl_patch.h>
+
+static __init int regpatch(void)
+{
+        return mvl_register_patch(1339);
+}
+module_init(regpatch);
EOF

    rv=0
    cat /tmp/mvl_patch_$$
    if [ "$?" != "0" ]; then
	# Patch had a hard error, return 2
	rv=2
    elif grep '^Hunk' ${TMPFILE}; then
	rv=1
    fi

    rm -f ${TMPFILE}
    return $rv
}

function options() {
    echo "Options are:"
    echo "  --force-unsupported - Force the patch to be applied even if the"
    echo "      patch is out of order or the current kernel is unsupported."
    echo "      Use of this option is strongly discouraged."
    echo "  --force-apply-fuzz - If the patch has fuzz, go ahead and apply"
    echo "      it anyway.  This can occur if the patch is applied to an"
    echo "      unsupported kernel or applied out of order or if you have"
    echo "      made your own modifications to the kernel.  Use with"
    echo "      caution."
    echo "  --remove - Remove the patch"
}


function checkpatchnum() {
    local level;

    if [ ! -e ${1} ]; then
	echo "${1} does not exist, make sure you are in the kernel" 1>&2
	echo "base directory" 1>&2
	exit 1;
    fi

    # Extract the current patch number from the lsp info file.
    level=`grep '#define LSP_.*PATCH_LEVEL' ${1} | sed 's/^.*\"\\(.*\\)\".*\$/\\1/'`
    if [ "a$level" = "a" ]; then
	echo "No patch level defined in ${1}, are you sure this is" 1>&2
	echo "a valid MVL kernel LSP?" 1>&2
	exit 1;
    fi

    expr $level + 0 >/dev/null 2>&1
    isnum=$?

    # Check if the kernel is supported
    if [ "$level" = "unsupported" ]; then
	echo "**Current kernel is unsupported by MontaVista due to patches"
	echo "  begin applied out of order."
	if [ $force_unsupported == 't' ]; then
	    echo "  Application is forced, applying patch anyway"
	    unsupported=t
	    fix_patch_level=f
	else
	    echo "  Patch application aborted.  Use --force-unsupported to"
	    echo "  force the patch to be applied, but the kernel will not"
	    echo "  be supported by MontaVista."
	    exit 1;
	fi

    # Check the patch number from the lspinfo file to make sure it is
    # a valid number
    elif [ $isnum = 2 ]; then
	echo "**Patch level from ${1} was not a valid number, " 1>&2
	echo "  are you sure this is a valid MVL kernel LSP?" 1>&2
	exit 1;

    # Check that this is the right patch number to be applied.
    elif [ `expr $level $3` ${4} ${2} ]; then
	echo "**Application of this patch is out of order and will cause the"
	echo "  kernel to be unsupported by MontaVista."
	if [ $force_unsupported == 't' ]; then
	    echo "  application is forced, applying patch anyway"
	    unsupported=t
	else
	    echo "  Patch application aborted.  Please get all the patches in"
	    echo "  proper order from MontaVista Zone and apply them in order"
	    echo "  If you really want to apply this patch, use"
	    echo "  --force-unsupported to force the patch to be applied, but"
	    echo "  the kernel will not be supported by MontaVista."
	    exit 1;
	fi
    fi
}

#
# Update the patch level in the file.  Note that we use patch to do
# this.  Certain weak version control systems don't take kindly to
# arbitrary changes directly to files, but do have a special version
# of "patch" that understands this.
#
function setpatchnum() {
    sed "s/^#define LSP_\(.*\)PATCH_LEVEL[ \t*]\"[0-9]*\".*$/#define LSP_\1PATCH_LEVEL \"${2}\"/" <${1} >/tmp/$$.tmp1
    diff -u ${1} /tmp/$$.tmp1 >/tmp/$$.tmp2
    rm /tmp/$$.tmp1
    sed "s/^+++ \/tmp\/$$.tmp1/+++ include\/linux\/lsppatchlevel.h/" </tmp/$$.tmp2 >/tmp/$$.tmp1
    rm /tmp/$$.tmp2
    patch -p0 </tmp/$$.tmp1
    rm /tmp/$$.tmp1
}

force_unsupported=f
force_apply_fuzz=""
unsupported=f
fix_patch_level=t
reverse=f
common_patchnum_diff='+ 1'
common_patchnum=$PATCHNUM
patch_extraopts=''

# Extract command line parameters.
while [ $# -gt 0 ]; do
    if [ "a$1" == 'a--force-unsupported' ]; then
	force_unsupported=t
    elif [ "a$1" == 'a--force-apply-fuzz' ]; then
	force_apply_fuzz=y
    elif [ "a$1" == 'a--remove' ]; then
	reverse=t
	common_patchnum_diff=''
	common_patchnum=`expr $PATCHNUM - 1`
	patch_extraopts='--reverse'
    else
	echo "'$1' is an invalid command line parameter."
	options
	exit 1
    fi
    shift
done

echo "Checking patch level"
checkpatchnum ${LSPINFO} ${PATCHNUM} "${common_patchnum_diff}" "-ne"

if ! dopatch -p1 --dry-run --force $patch_extraopts; then
    if [ $? = 2 ]; then
	echo -n "**Patch had errors, application aborted" 1>&2
	exit 1;
    fi

    # Patch has warnings
    clean_apply=${force_apply_fuzz}
    while [ "a$clean_apply" != 'ay' -a "a$clean_apply" != 'an' ]; do
	echo -n "**Patch did not apply cleanly.  Do you still want to apply? (y/n) > "
	read clean_apply
	clean_apply=`echo "$clean_apply" | tr '[:upper:]' '[:lower:]'`
    done
    if [ $clean_apply = 'n' ]; then
	exit 1;
    fi
fi

dopatch -p1 --force $patch_extraopts

if [ $fix_patch_level = 't' ]; then 
    if [ $unsupported = 't' ]; then
	common_patchnum="unsupported"
    fi

    setpatchnum ${LSPINFO} ${common_patchnum}
fi

# Move the patch file into the mvl_patches directory if we are not reversing
if [ $reverse != 't' ]; then 
    if echo $0 | grep '/' >/dev/null; then
	# Filename is a path, either absolute or from the current directory.
	srcfile=$0
    else
	# Filename is from the path
	for i in `echo $PATH | tr ':;' '  '`; do
	    if [ -e ${i}/$0 ]; then
		srcfile=${i}/$0
	    fi
	done
    fi

    fname=`basename ${srcfile}`
    diff -uN mvl_patches/${fname} ${srcfile} | (cd mvl_patches; patch)
fi

